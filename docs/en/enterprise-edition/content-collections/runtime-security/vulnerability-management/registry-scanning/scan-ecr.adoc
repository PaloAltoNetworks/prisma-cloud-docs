[#scan-ecr]
== Scan images in Amazon Elastic Container Registry (ECR)

To scan a repository, Prisma Cloud has to authenticate with Amazon ECR using either an IAM user (service account) or IAM role.
The minimum permissions policy required is *AmazonEC2ContainerRegistryReadOnly*.
It is a managed, predefined policy.
AWS managed policies grant the minimum set of permissions required for common use cases so you don't need to spend a lot of time investigating permissions yourself.

[.task]
=== Authenticate Prisma Cloud to ECR

The *AmazonEC2ContainerRegistryReadOnly* permissions policy is currently defined as follows:

[source,json]
----
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PrismaCloudComputeECRScanning",
            "Effect": "Allow",
            "Action": [
                "ecr:BatchCheckLayerAvailability",
                "ecr:BatchGetImage",
                "ecr:DescribeImages",
                "ecr:DescribeRepositories",
                "ecr:GetAuthorizationToken",
                "ecr:GetDownloadUrlForLayer",
                "ecr:GetRepositoryPolicy",
                "ecr:ListImages"
            ],
            "Resource": "*"
        }
    ]
}
----

*Prerequisites:* You have xref:../../install/deploy-defender/defender-types.adoc[installed a Defender] somewhere in your environment.

[.procedure]
. Open Console and go to *Defend > Vulnerabilities > Images > Registry settings*.

. Select *Add registry*.

. In the dialog, enter the following information:

.. In *Version*, select *Amazon EC2 Container Registry*.

.. In *Registry*, enter the URL for the registry. This should be of format: *<acct_id>.dkr.ecr.<region>.amazonaws.com*

.. In *Repository*, enter the name of the repository to scan.

.. In *Tag*, enter an image tag.
Leave this field blank to scan all tags.

.. Configure how xref:../../authentication/credentials-store/credentials-store.adoc[Prisma Cloud authenticates with AWS].
+
You can use an IAM user, IAM role, or AWS STS.

.. In *OS type*, specify whether the repo holds *Linux* or *Windows* images.

.. In *Scanners scope*, specify the collections of defenders to use for the scan.
+
Console selects the available Defenders from the scope to execute the scan job according to the *Number of scanners* setting.
For more information, see xref:../../vulnerability-management/registry-scanning/configure-registry-scanning.adoc#deployment-patterns[deployment patterns].

.. In *Number of scanners*, enter the number of Defenders across which scan jobs can be distributed.

.. Set *Cap* to the number of most recent images to scan.
Leaving *Cap* set to *5* will scan the 5 most recent images.
Setting this field to *0* will scan all images.

.. Select *Add*.

. Select *Save and scan*.
+
Verify that the images in the repository are being scanned under *Monitor > Vulnerabilities > Images > Registries*.
