== Scan Images in Google Container Registry (GCR)

[.task]
=== Configure a GCR Registry Scan

*Prerequisites:*

* xref:../../install/deploy-defender/defender-types.adoc#[Install a Defender] somewhere in your environment.

// Stroage view role discussion from https://panw-global.slack.com/archives/CL11MD99Q/p1572381568427500
* GCR access is governed by Google's storage permissions.
For Prisma Cloud to scan GCR, your service account must have the GCP IAM *Storage Object Viewer* role (see https://cloud.google.com/container-registry/docs/access-control#permissions_and_roles[Permissions and roles]).

* Grant Prisma Cloud access to your registry with a https://cloud.google.com/container-registry/docs/advanced-authentication[service account JSON key file].
Your JSON token blob will look something like this:
+
[source,yaml]
----
{
  "type": "service_account",
  "project_id": "my_project_id",
  "private_key_id": "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
  "private_key": "-----BEGIN PRIVATE KEY-----\nXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX==\n-----END PRIVATE KEY-----\n",
  "client_email": "XXXXXXXXXXXXXXX@XXXXXXXXXXXXXX.iam.gserviceaccount.com",
  "client_id": "XXXXXXXXXXXXXXXXXXXXXXXXX",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX.iam.gserviceaccount.com"
}
----

[.procedure]
. Open Console, then go to *Defend > Vulnerabilities > Images > Registry settings*.

. Select *Add registry*.

. In *Version*, select *Google Container Registry*. 

. Enter the registry address in the *Registry* field (e.g. `gcr.io`).

. Enter the repository name followed by `/{asterisk}` in the *Repository* field (e.g. `company-sandbox/*`).

. In *Credential*, enter the credentials required to access the registry. If the credentials have already been created in the Prisma Cloud credential store, select it. If not, click *Add* to create new credentials. 
+
image::gcr_add_registry.png[width=800]

.. Select the *GCP* credential type and credential level, then paste the JSON token blob from your service account into the *Service Account* field.
Leave the *API Token* field blank.
+
image::gcr_create_new_credential.png[width=800]
+
NOTE: For GCP organizations with hundreds of projects, scanning GCR using organization level credentials might affect the scanning performance due to long query time from GCP. Therefore, the best approach to reduce scan time and to avoid potential timeouts, is to divide the projects within your organization into multiple GCP folders. Then, create a service account and credential for each one of them, and use these credentials for GCR scanning.   

.. Save your credentials.

. In *OS type*, specify whether the repo holds *Linux* or *Windows* images.

. In *Scanners scope*, specify the collections of defenders to use for the scan.
+
Console selects the available Defenders from the scope to execute the scan job according to the *Number of scanners* setting.
For more information, see xref:../../vulnerability-management/registry-scanning/configure-registry-scanning.adoc#deployment-patterns[deployment patterns].

. In *Number of scanners*, enter the number of Defenders across which scan jobs can be distributed.

. Set *Cap* to the number of most recent images to scan.
+
Leaving *Cap* set to *5* will scan the 5 most recent images.
Setting this field to *0* will scan all images.

. Select *Add and scan*.
+
Verify that the images in the repository are being scanned under *Monitor > Vulnerabilities > Images > Registries*.
