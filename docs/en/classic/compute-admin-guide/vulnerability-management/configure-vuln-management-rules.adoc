== Vulnerability management rules

Vulnerability policies are composed of discrete rules that enable you to target segments of your environment and specify actions to take when vulnerabilities of a given type are found.
For example:

{nbsp} _Block images with critical severity vulnerabilities from being deployed to prod environment hosts_

There are separate vulnerability policies for containers, hosts, and serverless functions.
Host and serverless rules offer a subset of the capabilities of container rules, the big difference being that container rules support blocking.


[.task]
=== Configure vulnerability rules

Prisma Cloud ships with a simple default vulnerability policy for containers, hosts, and serverless functions.
These policies have a rule named _Default - alert all components_, which sets the alert threshold to low.
With this rule, all vulnerabilities in images, hosts, and functions are reported.

As you build out your policy, you'll create rules that filter out insignificant information, such as low severity vulnerabilities, and surface vital information, such as critical vulnerabilities.

xref:../configure/rule_ordering_pattern_matching.adoc#_rule_order[Rule order] is important.
Prisma Cloud evaluates the rule list from top to bottom until it finds a match based on the object filters.

To create a vulnerability rule:

[.procedure]
. Open Console.

. Go to *Defend > Vulnerabilities > {Images | Hosts | Functions}*.

. Click *Add rule*.

. Enter a rule name and configure the rule.
+
Use the configuration options are discussed in the following sections.

. Click *Save*.

. View the impact of your rule.
Go to *Monitor > Vulnerabilities* to view the scan reports.


[.task]
=== Scan All Images in Your Environment
By default, Prisma Cloud optimizes resource usage by only scanning images with running containers. 
Therefore, you might not see a scan report for an image when it's first pulled into your environment unless it's been run. Also, images for short-lived containers are not scanned.

[.procedure]
. Select *Manage > System > Scan*.

. Set *Only scan images with running containers* to *Off*.
+
This enables you to scan all images on the hosts in your environment. 

. *Save* your changes.



=== Customize  Terminal Output

Prisma Cloud lets you create rules that block access to resources or block the deployment of vulnerable containers.
For example, you might create a rule that blocks the deployment of any image that has critical severity vulnerabilities.
By default, when you try to run a vulnerable image, Prisma Cloud returns a terse response:

  $ docker run -it ubuntu:14.04 sh
  docker: Error response from daemon: [Prisma Cloud] Image operation blocked by policy: (sdf), has 44 vulnerabilities, [low:25 medium:19].

To help the operator better understand how to handle a blocked action, you can enhance Prisma Cloudâ€™s default response by:

* Appending a custom message to the default message.
For example, you could tell operators where to go to open a ticket.

* Configuring Prisma Cloud to return an itemized list of compliance issues rather than just a summary.
This way, the operator does not need to contact the security team to determine which issues are preventing deployment.
They are explicitly listed in the response.

When terminal output verbosity is set to *Detailed*, the response looks as follows:

  $ docker run -it ubuntu:14.04 sh
  docker: Error response from daemon: [Prisma Cloud] Image operation blocked by policy: (sdf), has 44 vulnerabilities, [low:25 medium:19].
  Image          ID       CVE             Package   Version             Severity   Status
  =====          ==       ===             =======   =======             ========   ======
  ubuntu:14.04   4333f1   CVE-2017-2518   sqlite3   3.8.2-1ubuntu2.1    medium     deferred
  ubuntu:14.04   4333f1   CVE-2017-6512   perl      5.18.2-2ubuntu1.1   medium     needed
  .
  .
  .


[.task]
==== Configure grace period

The following procedure describes how to configure grace periods for blocking actions: 

[.procedure]
. In Console, go to *Defend > Vulnerabilities > Images > Deployed*.

. Select an existing rule or create a new rule with the *Add rule* button.

. Enter a rule name, notes, and scope.

. Under *Severity based actions*:

.. Select the desired *Alert threshold*

.. Select the desired *Block threshold*.
+
The block threshold must be equal to or greater than the alert threshold.
You must define a block threshold in order to configure grace period.

.. Configure the *Block grace period*:

... Select whether you would like to define the same grace period for *All severities* or grace period *By severity*.

... Specify the number of days.
Note that in case of *By severity* grace period you will be able to specify the number of days only for the severities that can be blocked.
Values that are not set will be set to 0. 
+
image::vuln_management_rules_grace_period_by_severity.png[width=700]
+
NOTE: Use the same procedure to configure grace periods to fail builds in your CI/CD pipeline.
To configure CI/CD pipeline vulnerability scanning rules, go to *Defend > Vulnerabilities > Images > CI*.

[.task]
=== Configuring the severity of reported CVEs

By default, Prisma Cloud reports all vulnerabilities.
Setting the minimum reported severity lets you clean up the reported vulnerabilities to an actionable set.

To configure a minimum severity, install a new vulnerability rule, which overrides the default rule.
Note that Prisma Cloud maps the Common Vulnerability Scoring System (CVSS) to a
xref:../vulnerability_management/cvss_scoring.adoc#[grading system that ranges from Low to Critical.]

[.procedure]
. Open Console, and go to *Defend > Vulnerabilities > Images > Deployed > Add rule*.

. Click *Add rule*.

. Give your rule a name.

. In the table of *Severity based actions*, set the *Severity* in each row to an appropriate level.
For example, if you want to concentrate on just the most severe issues, set every row to *Critical*.

. Click *Save*.

. View the scan reports for all the entities in your system.
+
Go to *Monitor > Vulnerabilities*.
All reported vulnerabilities match or exceed the severity setting in your custom rule.

[.task]
=== Block based on vulnerability severity

This example shows you how to create and test a rule that blocks the deployment of images with critical or high severity vulnerabilities.

[.procedure]
. In Console, go to *Defend > Vulnerabilities > Images*.

. Click *Add rule*.

.. Enter a rule name, such as *my-rule*.

.. In the *Severity based actions* table, set both the *Alert threshold* and *Block threshold* to *High*.

.. Target the rule to a very specific image.
In the *Images* filter, delete the wildcard, and enter *nginx{asterisk}*.

.. Click *Save*.

. Validate your policy by pulling down the nginx image and running it.

.. SSH to a host protected by Defender.

.. Pull the nginx:1.14 image.

  $ docker pull nginx:1.14

.. Run the nginx image.

  $ docker run -it nginx:1.14 /bin/sh
  docker: Error response from daemon: oci runtime error: [Prisma Cloud] Image operation blocked by policy: my-rule, has 7 vulnerabilities, [high:7].

.. Review the scan report for nginx:1.14.
Go to *Monitor > Vulnerabilities > Images*, and click on the entry for nginx:1.14.
You'll see a number of high severity vulnerabilities.
+
By default, Prisma Cloud optimizes resource usage by only scanning images with running containers.
Therefore, you won't see a scan report for ngninx until it's run.
+
image::vuln_management_rules_scan_report.png[width=700]

.. Review the audit (alert) for the block action.
Go to *Monitor > Events*, then click on *Docker*.
+
image::vuln_management_rules_block_audit.png[width=700]


[.task]
=== Block specific CVEs

This example shows you how to create and test a rule that blocks images with a specific CVE.

[.procedure]
. In Console, go to *Defend > Vulnerabilities > Images*.

. Click *Add rule*.

.. Enter a rule name, such as *my-rule2*.

.. Click *Advanced settings*.

.. In *Exceptions*, click *Add Exception*.

.. In *CVE*, enter *CVE-2018-8014*.
+
NOTE: You can find specific CVE IDs in the image scan reports.
Go to *Monitor > Vulnerabilities > Images*, select an image, then click *Show details* in each row.

.. In *Effect*, select *Block*.

.. Click *Add*.

.. Click *Save*.

. Try running an image with the CVE that you've explicitly denied.

  $ docker run -it imiell/bad-dockerfile:latest /bin/sh
  docker: Error response from daemon: oci runtime error: [Prisma Cloud] Image operation blocked by policy: my-rule2, has specific CVE CVE-2018-8014


=== Ignore specific CVEs

Follow the same procedure as above, but set the action to *Ignore* instead of *Block*.
This will allow any CVE ID that you've defined in the rule, and lets you run images containing those CVEs in your environment.
