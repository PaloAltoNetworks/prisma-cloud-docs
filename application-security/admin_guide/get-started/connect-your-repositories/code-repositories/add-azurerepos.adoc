:topic_type: task

[.task]
== Add Azure Repos to Prisma Cloud Code Security

Integrating Azure Repos enables Prisma Cloud to scan your Infrastructure-as-code files (such as Terraform and CloudFormation), open source packages, licenses and CI/CD systems for misconfigurations, vulnerabilities, exposed secrets, license non-compliance and CI/CD system issues.

The integration uses OAuth tokens to help you integrate multiple Azure Repos on the Prisma Cloud console. Enable OAuth tokens on Azure Repos to configure multiple organizations from either the same Azure Repos account or a different one.

As a prerequisite, add the Prisma Cloud IP addresses and hostname for Code Security to an allow list, to https://docs.paloaltonetworks.com/prisma/prisma-cloud/prisma-cloud-admin/get-started-with-prisma-cloud/enable-access-prisma-cloud-console.html#id7cb1c15c-a2fa-4072-%20b074-063158eeec08[enable access to the Prisma Cloud console].


[.procedure]

. Verify prerequisites.
+
For Azure Repos integration with Prisma Cloud Code Security, you need to verify access to the Azure DevOps console to help with authorization and third-party application access using OAuth.
+
* Authorization access.
+
Access to Azure DevOps console enables you to grant authorization access to Prisma Cloud during integration to access organizations and repositories associated with your user token.
+
* Third-party application access via OAuth.
+
To configure integration either for a single organization or multiple organizations from a single user token, you must enable third-party application access via OAuth on the Azure DevOps console.
+
image::azure-third-party-oauth.png[width=800]
+
The https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/change-application-access-policies?view=azure-devops[third-party application access via OAuth] gives Prisma Cloud access to all your organizations associated with your user token.
+
* Do not limit authorization scope
+
To ensure that Prisma Cloud has access to the repositories, ensure that the *Limit job authorization scope to current project for non-release pipelines* is set to *OFF*. This can be found in *Project Settings > Settings > General*.
+
image::azure-permission-settings.png[width=800]

. Access Azure Repos on Prisma Cloud Code Security.

.. Select *Settings > Code & Build Providers > Add*.

.. Select *Azure Repos* from Code Repositories.
+
image::azure-repos-select.png[width=800]

. Configure an Azure Repos account with Prisma Cloud console: 

.. Select *Authorize* to configure an Azure Repos account with Single Organization.
+
image::azure-repos-1.1.png[width=600]
+
You can optionally select *Multiple Organization* and then *Authorize* to configure an Azure Repos account which includes Multiple Organizations.
+
If there is an existing Azure Repos integration, you can either continue with a new organization configuration or select *Skip* to select repositories for a security scan.
+

NOTE: To skip an authorization, you must have an existing integration.

.. Access the Azure DevOps console and then select *Accept* to authorize the Prisma Cloud console to access your organization account and repositories.
+

NOTE: For an existing Azure Repos integration, you can additionally choose to either *Reselect repositories* to edit the existing configuration or *Revoke OAuth User Token* to delete the user token and the associated repositories on the Prisma Cloud console. The configuration is accessible from either single organization or multiple organization.
+
image::azure-repos-4.1.png[width=600]
+
Successful authorization on the Azure DevOps console directs you to the Prisma Cloud console.

. Optional: Enable the CI/CD Security module to gain visibility into, and protect your Azure Repos environment:
+

image:: azure-cicd-int.png

.. Enter your user name in the *User Name* field. 

NOTE: To retrieve your user name: In your Azure organization, select *User settings* > *Profile*.

.. Generate a xref:https://learn.microsoft.com/en-us/azure/devops/organizations/accounts/use-personal-access-tokens-to-authenticate?view=azure-devops&tabs=Windows[Personal Access Token] (PAT) in Azure Repos, and copy and save.
+

NOTE: Configure the following values while creating the token:

* Select *all accessible organizations* in the Organization field, and set an Expiration date

* Authorize the following scope of access associated with the token: 

** Agent Pools (Read)

** Analytics (Read)

** Auditing (Read Audit Log)

** Member Entitlement Management (Read)

** Pull Request Threads (Read & write)

** Service Connections (Read)

** Tokens (Read & manage)

** Variable Groups (Read)

.. Enter the generated PAT in the *App Password* field > *Next*.

. Select repositories to be scanned.

.. Select a configured *OAuth user token* to view the associated repositories for a security scan.
+

A user token, by default, is always enabled. You can also configure other user tokens by selecting a specific user token.

NOTE: Use configured tokens that are displayed in the *Configure Account* screen, not the personal access token generated for CI/CD security integration in *step 4* above.

image::azure-repos-5.1.png[width=600]


.. Define the repositories to be scanned from the available options: 
+

* *Permit all existing repositories*: Enables Prisma Cloud to scan all existing repositories that are associated with the selected PAT
* *Permit all existing and future repositories*: Enables Prisma Cloud to scan all existing repositories and any new repositories that are subsequently associated with the PAT
* *Choose from repository list*: This option enables you to select specific repositories for scan

+

NOTE: A single repository may be shared across one or more user tokens. In this case, any change made to a shared repository scan applies to all associated user tokens.

.. Select *Next* to confirm the repository selection and save the changes.

.. Select *Done* in the *New integration successfully configured* screen.

. Verify that the Azure Repos integration with Prisma Cloud is successful:

.. Select *Settings* > *Code & Build Providers*. 

.. Verify that the *Azure Repos* integration is displayed from the  *VCS User Token* column.
+

NOTE: You may have to wait for up to three minutes before the status of the integration is updated and displays 

+
image::azure-repos-9.1.png[width=800]
+
On *Code & Build Providers*, you can also manage the integration by reselection of repositories and deletion of the repository and the integration.
+
* *Reselect repositories*: Enables you to access the list of repositories for a scan.
* *Delete repository*: Enables you to delete repositories for a scan from the account.
* *Manage VCS user tokens*: Enables you to integrate one or more Azure Repos accounts.
+

NOTE: You cannot delete the integration from *Repositories* for an account integration that supports multiple user tokens.
+

After a code security scan, access *Application Security* > *Projects* to view the latest integrated Azure Repos repositories scan results to xref:../../scan-monitor/monitor-fix-issues-in-scan/monitor-fix-issues-in-scan.adoc[Suppress] or xref:../../scan-monitor/monitor-fix-issues-in-scan/monitor-fix-issues-in-scan.adoc[Fix] the policy misconfigurations.
