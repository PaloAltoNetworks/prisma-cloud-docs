== Pivotal Cloud Foundry blobstore scanning

Prisma Cloud for Pivotal Cloud Foundry (PCF) scans the droplets in your blobstores for vulnerabilities.

PCF is a Platform as a Service (PaaS) that runs applications on your infrastructure.
Applications in PCF are deployed, scaled, and monitored by BOSH, which is PCF's infrastructure lifecycle management tool.
PCF stores large binary files in blobstores.
Blobstores are roughly equivalent to registries.
One type of file stored in the blobstore is the droplet.

Droplets are archives that contain ready to run applications.
They are roughly equivalent to container images.
Droplets contain the OS stack, a buildpack (which contains the languages, libraries, and services used by the app), and custom app code.
Before running an app on your infrastructure, the Cloud Controller stages it for delivery by combining the OS stack, buildpack, and source code into a droplet, then storing the droplet in a blobstore.

Prisma Cloud is packaged as tile.
When the tile is installed, it runs Defender as a PCF service in a dedicated VM on your infrastructure.
Like all Defenders, the PCF Defender must be able to connect over the network to Prisma Cloud Console.

The _twistcli_ command line tool also lets you scan droplet files directly.
You can integrate _twistcli_ into your CLI to pass or fail builds based on vulnerability thresholds.


[.task]
=== Install the PCF Defender

The PCF Defender is delivered as a tile.
Go to the PCF Ops Manager Installation Dashboard to install the tile.

ifdef::compute_edition[]
*Prerequisites:*

* Prisma Cloud Console has already been installed.
One option is to xref:../install/install_pks.adoc#[install Console on Pivotal Container Service (PKS)], although there are xref:../install/getting_started.adoc#[many options], including xref:../install/install_onebox.adoc#[Onebox].
endif::compute_edition[]

NOTE: External blobstores that require a custom authentication flow, such as those offered by cloud providers, are not supported.

[.procedure]
. https://docs.twistlock.com/docs/latest/download/releases.html[Download] the latest Prisma Cloud release to your local host.

. In the Ops Manager Installation Dashboard, click *Import a Product*.

. Select the tile from the Prisma Cloud release directory.
It can be found in TWISTLOCK-RELEASE/pivotal/twistlock-tile-VERSION.pivotal.

. Retrieve the install command from Prisma Cloud Console.
It will be used to configure the tile.

.. Log into Prisma Cloud Console.

.. Go to *Manage > Defenders > Deploy*.

.. Choose the DNS name or IP address the PCF Defender will use to connect to Console.
   If a suitable option is not available, go to *Manage > Defenders > Names*, and add a DNS name or IP address to the SAN table.

.. Set the Defender type to *PCF*.

.. Leave the Defender listener type set to *None*.

.. Copy the install command and set it aside.

. Navigate to the PCF Ops Manager Installation Dashboard.

. Add the Prisma Cloud tile to your staging area.
Click the *+* button next to the version of the tile you want to install.
+
image::pcf_blobstore_add_tile_to_staging.png[width=300]

. Click the newly added *Prisma Cloud for PCF* tile.
+
image::pcf_blobstore_tile.png[width=300]

. Configure the tile.
+
image::pcf_blobstore_configure_tile.png[width=450]

.. In *Assign AZs and Network Assignments*, specify where Prisma Cloud Defender should run, then click *Save*.
+
Prisma Cloud for PCF runs as a service.
If you have a dedicated subnet for services, run it there.
+
By default Prisma Cloud performs strict validation of your Cloud Controller's (CC) TLS certificate.
If you're using self-signed certificates, this check will failure.
To add your custom certificates to trusted cert list, you need to add the custom CA's cert on the VM where the Prisma Cloud tile runs. 
For more details about how to do this, refer to https://docs.pivotal.io/pivotalcf/2-4/customizing/trusted-certificates.html[Pivotal's trusted certificates article].
+
To skip strict validation of your Cloud Controller's (CC) TLS certificate, enable *Skip Cloud Controller TLS validation*.
Strict validation verifies the name, signer, and validity date of the CC's certificate.
Even with strict validation disabled, the sesssion is still encrypted.
Skip strict validation when:
+
* You're using self-signed certificates
* You're using certificates signed by a CA that isn't in your cert store
* When there's a mismatch between the address you're using to connect to the CC and the common name (CN) or subject alternative name (SAN) in the CC's certificate.

.. In *Prisma Cloud Component Configuration*, enter the install command you copied from Prisma Cloud Console, then click *Save*.

ifdef::compute_edition[]

.. In *Credentials*, select your preferred authentication method: Basic Authentication or Certificate-based Authentication:
+
For Basic Authentication, enter your Prisma Cloud Console credentials, then click *Save*.
+
For Certificate-based Authentication, paste the certificate and private key used for authentication in PEM format, then click *Save*.
+
Notes:
+
* Your xref:../access_control/user_roles.adoc[role] must be Defender Manager or higher.
* For Certificate-based Authentication, the root CA used to sign the certificate used for authentication must be entered under *Manage > Authentication > System Certificates > Advanced Certificate Configuration*. 

endif::compute_edition[]

ifdef::prisma_cloud[]

.. In **Credentials**, enter your Prisma Cloud Console credentials, then click *Save*.
Your https://docs.twistlock.com/docs/latest/access_control/user_roles.adoc[role]  must be Defender Manager or higher.
+
NOTE: Certificate-based authentication is not supported with Prisma Cloud Enterprise.

endif::prisma_cloud[]



. Install the Prisma Cloud tile.
Return to the Ops Manager Installation Dashboard, click *Review Pending Changes*, select *Prisma Cloud for PCF*, then click *Apply changes*.

. After the changes are applied, validate that Prisma Cloud Defender is running.
Log into Prisma Cloud Console, then navigate to *Manage > Defenders > Manage*.
In the table of deployed Defenders, you should see a Defender of type *PCF*.
+
image::pcf_blobstore_defender_installed.png[width=800]


[.task]
=== Configure Prisma Cloud to scan a blobstore

Prisma Cloud can scan internal and external blobstores, and blobstores configured to use the Fog Ruby gem or WebDAV protocol.

[.procedure]
. Log into Prisma Cloud Console.

. Go to *Defend > Vulnerabilities > PCF Blobstore*.

. Click *Add PCF Blobstore settings*.

. Specify the cloud controller.

. Specify the droplets to scan.
To scan all droplets, enter a wildcard (*).

. Specify the maximum number of droplets to scan.
To scan all droplets, enter 0.

. Click *Add*.

. Click *Save*.


[.task]
=== Review scan reports

Scan reports show all vulnerabilities found in the droplets in blobstores.
By default, droplets are rescanned every 24 hours.

[.procedure]
. Log into Prisma Cloud Console.

. Go to *Monitor > Vulnerabilities > PCF Blobstore* to see a list of summary reports for each droplet.

. To drill into a specific scan report, click on a row in the table.
