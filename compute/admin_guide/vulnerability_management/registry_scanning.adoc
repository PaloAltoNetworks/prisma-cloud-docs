== Configure Registry Scans

Prisma Cloud can scan container images in public and private repositories on public and private registries.

A registry is a system that stores and distributes container images.
The most well-known public registry is Docker Hub, but you can use other registries from Amazon, Google, and other providers.
Your organization can set up its own internal private registries too.
Prisma Cloud supports scanning container images on all these registries.

After you configure repository scanning, Prisma Cloud automatically scans images for vulnerabilities.
By default, scans occur once every 24 hours, but you can configure periodic scans at specific intervals specified in *Configure > System > Scan*.


[.task, #_registry_scan_settings]
=== Configure Prisma Cloud to Scan a Registry

To scan images in a registry, create a new registry scan rule.

*Prerequisites:* You have xref:../install/defender_types.adoc[deployed at least one Defender in your environment].

To avoid interrupting an ongoing scan, Prisma Cloud provides the option to save your configuration without restarting the scan.
When saving your configuration changes, you are prompted on whether you want to save the changes and start a new scan or to save your changes and wait until the next scheduled scan.
If you use the `/settings/registry` API to manage registry scanning, you can use the `scanLater` flag when using the `PUT` or `POST` methods to decide whether to initiate a scan after saving or not.
By default, Prisma Cloud initiates a scan.

[.procedure]
. Open the Prisma Cloud Console.

. Go to *Defend > Vulnerabilities > Registry settings*.

. Review the available <<registry-scan-settings, settings>> if the default values don't fit your scenario.

. Click *Add registry*.

[#_deployment_patterns]
=== Deployment Patterns

Defenders handle registry scanning.
When you configure registry scanning, you can select the scope of defenders used to perform the scans.

Any xref:../install/defender_types.adoc[Container Defender] running on a host with the Docker Engine container runtime or container runtime interface (CRI) can scan a registry, and any number of them can simultaneously operate as registry scanners.
This flexibility gives you a lot of options when trying to determine how to cover disparate environments.

You can use host names or AWS tags to select a collection of defenders to distribute the scanning job between them, and use the *Number of scanners* setting to control how many defenders are included in the collection.
When you select the *All* collection, Prisma Cloud automatically distributes the scan job across all available defenders.

Configuring Prisma Cloud to use a large number of defenders reduces operational complexity and improves resiliency.
During a scan, Prisma Cloud lists the available defenders based on the configured scope, manages the resource pool, and handles issues such as restarting partially completed jobs. 
If you explicitly select one or two defenders to handle scanning, the hosts running those defenders become a single point of failure. If that host fails or gets destroyed, you have to reconfigure your scan settings with different defenders.

The type of operating system (OS) scopes registry scanning.
Windows defenders only scan Windows images, and Linux defenders only scan Linux images.

When you remove an image from the registry or the registry becomes unavailable, Prisma Cloud maintains the scan results for a specific number of days.
You can configure the number of days under *Manage > System > Scan > Registry scan results*.
After the specified number of days, the scan results are purged.

[#_registry-scan-steps]
=== Registry Scan Steps

At a high level, defenders scan your registries following these steps.

. Scan registry settings one by one in sequential order.
. Discover the repositories based on your registry configuration.
. Discover the images using tags within each configured repository.
. Scan the discovered images.

In more detail, defenders scanning your registries follow this sequential flow to collect the metadata.

. Get a list of all repositories in the registry.

. For each repository, scanning defenders perform the following tasks.
  * Get a list of all image tags.
  * For each image tag, they get the image manifest containing the date the image was last modified.

. Once the metadata of all images is discovered, scanning defenders perform the following tasks.
   * Sort the images by the last modified date.
   * Cap the list of images based on the configured value. By default, lists are capped at five.
   * Scan the images.

With a cap of five, scanning defenders fetch the five most recently modified images from each repository in the registry.
The registry scan can take longer if you set a large cap number or set the cap value to 0, which scans all images in a repository.

=== Registry Scan Settings

You can set the following parameters for each rule has the following parameters, but the parameters can vary between registry types.
If you use a specific registry provider, follow the appropriate step-by-step instructions in  xref:./registry_scanning/registry_scanning.adoc[our guides].

[cols="15%,85%a", options="header"]
|===
|Field
|Description

|Version
|Specify the type of registry to scan. 

 - If you do not find your vendor's registry in the drop-down list, try *Docker Registry v2*.
Most vendors comply with the Docker Registry version 2 API.

|Registry
|Specify the URL for the registry.

*Docker Hub:* leave this field blank.  

*Harbor*: specify the FQDN of your Harbor registry (\https://).

*Nexus Registry:*
*<http\|https://<nexus_hostname>:<HTTP/HTTPS connector port for the specific Nexus repo>*

Example: *https://ec2-100-25-223-135.compute-1.amazonaws.com:18079*

|Repository name
|Specify the repository to scan. 
This field supports xref:../configure/rule_ordering_pattern_matching.adoc#[pattern matching].
To scan all repositories, simply leave this field blank or enter a wildcard (`{asterisk}`).

*Docker Hub:*
To specify an official Docker repository, enter library/, followed by the short string used to designate the repo.
For example, to scan the images in the official Alpine Linux repository, enter library/alpine.

To specify non-official repositories, enter the username or organization name, followed by a slash, followed by the name of the repo.
For example, to specify the alpine repository in onescience's account, enter onescience/alpine.

To scan all repos from a user or organization, simply enter the user or organization name, followed by a wildcard (`{asterisk}`).
For example, to scan all repos created by onescience, enter onescience*.

*Google Cloud Platform Container Registry:*
Enter your project ID and image name in the following format: project-id/image-name.  To scan all images, follow the repository name with `/\*`. (e.g. `company-sandbox/*`) 

*Harbor:*
Enter the name of the repository, followed by a wildcard (`{asterisk}`).
For example, to scan the repository library, enter library*.

*Any Docker V2 API compliant registry:*
Docker Hub, Docker Registry, and Alibaba Container Registry all support the Docker Registry version 2 API.

*Nexus Registry:* Leave blank or include a pattern to match the Docker repositories inside the Nexus registry. For example: To scan all the images under a path, include the *path/to* string.

|Tag
|Specify an image tag.
Leave this field blank to scan all tags (limited by the value in Cap).

|Credentials
|Specify the credentials required to access the registry.
If the credentials have already been created in the Prisma Cloud credential store, select it.
If not, click *Add New*.

*Public repositories on public registries (such as Docker Hub):*
Leave this field blank.
No credentials are required.

*AWS EC2 Container Registry:*
Use the IAM access keys for authentication.
For more information, see xref:registry_scanning/scan_ecr.adoc[Amazon EC2 Container Registry (ECR).]

*Google Container Registry:*
Use the service account and JSON token.
For more information, xref:registry_scanning/scan_gcr.adoc[Google Container Registry (GCR).]

*Harbor Registry:*
Create a *Basic authentication* credential.
Credentials for Harbor can be a *Limited Guest*.

*Registries that support token authentication (e.g. Quary, GitLab):*
Create a *Basic authentication* credential.
_Username_ is the name of the token and the token value is entered into the _password_ field.

|OS Type
|Specify whether the image is built on a Windows or Linux based OS.

|Scanners scope
|Select collections of Defenders to scan this registry.

Only Linux Defenders can scan Linux container images, and only Windows Defenders can scan Windows container images.
App-Embedded Defenders can't be used for registry scanning.

|Number of scanners
|Number of Defenders from scope across which the scan job can be distributed.
Increase the number of Defenders to increase throughput and reduce scan time.

|Cap
|Specify the maximum number of images to scan in the given repository, sorted according to last modified date. That is, the most recently modified image in each repository is scanned first, followed by the image next most recently modified, and so on.

The Docker Registry API does not support directly querying for the most recently updated images.
To handle your CAP setting, Prisma Cloud first polls the registry for all tags and manifests in the given repository to discover the last updated dates.
This is a low overhead operation because images do not need to be downloaded.
Prisma Cloud then sorts the results by date and then scans the most recently updated images in each repository up to the limit specified by CAP.
Even when CAP is set to a low number, you might still notice the Prisma Cloud UI polling the registry for data about the images in the repository.

To scan all images in a repository, set CAP to 0.

|Version matching pattern
|Customize sort order by values in the image tag.
Specify a pattern from which a version or date can be extracted from the image tag.
There are two use cases for specifying version matching patterns:

* You want to reduce the total time it takes to complete the scan for very large registries.
Rather than fetching the metadata from the registry required to sort images, you specify how the scanner can extract the metadata directly from the image tag.
* You want to order and cap the images to be scanned by some value other than last modified date.

Specify patterns with strings, wildcards, time/date elements, and integers.

* `%d` - version number
* `%Y` - 4 digit year
* `%M` - 2 digit month
* `%D` - 2 digit day
* `%H` - 2 digit hour
* `%m` - 2 digit minute
* `%s` - 2 digit second

For image tags that match the pattern, the tag is split into its constituent parts.
After all image tags are parsed, they're ordered and capped according to the value set in Cap.

Ordering is the best-effort.
Tags that don't conform to the pattern are ignored.

If both date and version are specified in your pattern, the date takes precedence.

If the version matching pattern is left unspecified, Prisma Cloud orders images by last modified date.

|===

=== Registries with a Large Scale

If your registries are very large, optimize your scan configuration to maximize throughput and minimize scan time.
Defenders scan registries sequentially following <<_registry-scan-steps,specific steps>>.
The following best practices help you improve your registry scanning speed.

* If you have large registries or need aggressive scan intervals, increase the number of scanners in the scope.
+
The number of scanning defenders should increase with regard to the registry size. As the number of images in the registry increases, so does the number of defenders scanning this registry.

* Use the default cap value of five in your registry scan configuration.
+
The cap value impacts the duration of the scan. Large cap values lead to longer scan times since more images are scanned.

* Use a version matching pattern in your registry scan configuration. Only use version pattern matching for deployments with very large registries containing tens of thousands of repositories and millions of images.
+
If you specify a version matching pattern, the scanner looks to the image tag for sort order.
Without a version matching pattern, images are sorted by last modified date.
With a version matching pattern, you configure how image tags are sorted.
Using semantic versioning in your image names, you can specify the following version pattern:
+
[source]
----
*-%d.%d.%d
----
+
This optimized flow to collect metadata eliminates the sorting loop and substantially reduces the number of requests. Then, defenders can start scanning the registry sooner.
The simplified flow is as follows.
+
  . Get a list of all repos in the registry.
+
  . For each repository, scanning defenders perform the following tasks.
    * Get a list of all image tags
+
  . Once the metadata of all images is discovered, scanning defenders perform the following tasks.
     * Sort the images by last modified date.
     * Cap the list of images based on the configured value. By default, lists are capped at five.
     * Scan the images.
+
A repository with three images, configured with a cap of `2`, and a version pattern of `*-%d.%d.%d`, produces the following set of images to be scanned.
+
[source]
----
  myimage-3.0.0 <<<--- Image scanned
  myimage-2.0.1 <<<--- Image scanned
  myimage-2.0.0 (Not scanned)
----

* When you have multiple registries, create multiple collections of defender scanners.
+
Each registry should have dedicated Defenders to perform the scanning.
If a 1:1 ratio of collections to registries isn't feasible, create as many collections as possible to split the load. 
Don't reuse the same collection for all registries.
+
This best practice prevents the scenario where a single Defender performs too many queries to the registry provider API.
If too many queries are made during repository or tag discovery, providers could throttle the Defender. 

* Properly dimension the hardware running your defenders.
+
Ensure the xref:../install/system_requirements.adoc#hardware[hardware system requirements] for defenders scanning registries are met.

* Colocate scanning defenders in the same region as the registry.
+
This best practice minimizes network latency since the defenders run in the same region as your registries.

=== Additional Scan Settings

You can find additional scan settings under *Manage > System > Scan*, where you can set the xref:../configure/configure_scan_intervals.adoc#[registry scan interval].

The *Manage > System > Scan* page has an option called *Only scan images with running containers*.
This option does NOT apply to registry scanning. All images included in your registry scanning rule are scanned regardless of the setting to *Only scan images with running containers*.

=== CRI and containerd-only environments

Prisma Cloud fully supports scanning CRI and containerd-only environments.

=== Registry Scanning Limitations

When scanning registries, consider the following constraints.

* Defenders only scan the operating system images that match the OS of the system running them.
+
For example, a Defender running on a Linux host can only scan Linux images and won't scan Windows images.

* Defenders running on Linux only scan images suited for the hardware architecture that matches the architecture of the system running them.
+
For example, a Defender running on x86_64 architecture with Linux can only scan images for x86_64 systems with Linux.
Similarly, a Defender running on ARM64 architecture with Linux can only scan images for ARM64 systems with Linux.
You can't mix Linux ARM64 and Linux x86_64 defenders within the same registry scanning scope.
