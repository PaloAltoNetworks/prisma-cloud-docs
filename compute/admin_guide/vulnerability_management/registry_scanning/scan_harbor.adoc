== Scan images in Harbor Registry

Configure Prisma Cloud to scan your Harbor registry.

[.task]
=== Create a new registry scan

To scan a repository in Harbor, create a new registry scan setting.

[.procedure]
. Open Console

. Go to *Defend > Vulnerabilities > Images > Registry Settings*.

. Click *Add Registry*.

. In the dialog, enter the following information:

.. In the *Version* drop-down list, select *Harbor*.

.. In the *Registry* field, enter the FQDN of your Harbor registry (\https://).

.. In *Repository*, enter the name of the repository to scan, or leave this blank to scan all repositories.

.. In *Tag*, enter an image tag.
Leave this field blank to scan all images, regardless of any tags.

.. In *Credential*, select the credentials to use.
+
If Console doesn't have a copy of your credentials yet, click *Add New*.
Select *Basic authentication*, and fill out the rest of the fields.
The minimum required credentials for each repository is *Limited Guest*.

.. The *Bypass deployment security* toggle is applicable only when using Prisma Cloud Compute pluggable scanner. 
+
To scan Harbor projects with the deployment security setting enabled, Harbor requires additional permissions that can not be granted with a regular user credentials.
+
When the toggle is ON, Prisma Cloud Compute scans the registry using a temporary token provided by Harbor in the scanning request, instead of the credentials provided in the settings.
This token has sufficient permissions to bypass the deployment security setting, and it's the mechanism Harbor provides to allow external security scanners to scan these projects.
+
When the toggle is OFF, Prisma Cloud Compute uses the credentials provided in the setting to scan the registry.
It will not be able to scan images in Harbor projects with the deployment security setting enabled.
+
NOTE: Harbor's token expiration time must be at least 30 minutes so that it won't expire during the Prisma Cloud scanning process.
If you set the expiration period to less than 30 minutes, registry scanning might fail.   

.. In *OS type*, specify whether the repo holds *Linux* or *Windows* images.

.. In *Scanners scope*, specify the collections of defenders to use for the scan.
+
Console selects the available Defenders from the scope to execute the scan job according to the *Number of scanners* setting.
For more information, see xref:../../vulnerability_management/registry_scanning.adoc#_deployment_patterns[deployment patterns].

.. In *Number of scanners*, enter the number of Defenders across which scan jobs can be distributed.

.. Set *Cap* to the number of most recent images to scan.
Leaving *Cap* set to the default value of *5* will scan the most recent 5 images.
Setting this field to *0* will scan all images.

.. Click *Add*.

. Click the *Save* button.


[.task]
=== Results

Verify that the images in the repository are being scanned.

[.procedure]
. Go to *Monitor > Vulnerabilities > Images > Registries*.
+
A progress indicator at the top right of the window shows the status of the current scan.
As the scan of each image is completed, its findings are added to the results table.

. To get details about the vulnerabilities in an image, click on it.
+
To force a specific repository to be scanned again, select *Scan* from the top right of the results table, then click on the specific registry to rescan.


[.task]
=== Integrate Compute as pluggable scanner

Configure Compute as a pluggable scanner to view vulnerability scan results in Harbor Console itself, in addition to Compute Console.
To add Compute as a vulnerability scanner in Harbor, follow steps outlined above for adding Harbor registry in Compute Console.
Thereafter, follow the steps below in Harbor:

[.procedure]
. In Harbor, go to the Administration > Interrogation Services page and click New Scanner. 

. In the pop up, enter your Compute Console details.

.. In *Name*, provide a name for the scanner.

.. In *HTTP Endpoint*:
+
Login to your Compute Console, navigate to Defend > Vulnerabilities > Registry page. 
Under *Harbor scanner adapter* section, copy the URL from field b: "Use the following URL as the Harbor Scanner endpoint".
+
NOTE: This section only becomes visible after adding Harbor Registry in Compute Console as a registry as per steps outlined in section above. 

.. *Authorization: None*:
+
NOTE: Due to a current bug in all Harbor versions other types of authentication methods result in error messages.
See https://github.com/goharbor/harbor/issues/12919

. Test Connection and click *Save*.
+
You can now go to Vulnerability tab under Interrogation services and hit Scan Now for vulnerability scanning reports.
+
Note that when a scan is revoked from Harbor Console using Compute as a vulnerability scanner, Harbor pulls scan from Compute Console. In order to receive faster results, make sure you scan the registry on Compute Console as well. 
