== Google Container Registry (GCR)

Scan GCR registries.

[.task]
=== Scan images on Google Container Registry

*Prerequisites:*

* You have xref:../../install/defender_types.adoc#[installed a Defender] somewhere in your environment.

// Stroage view role discussion from https://panw-global.slack.com/archives/CL11MD99Q/p1572381568427500
* GCR access is governed by Google's storage permissions.
For Prisma Cloud to scan GCR, your service account must have the GCP IAM *Storage View* role.

* You must grant Prisma Cloud access to your registry with a https://cloud.google.com/container-registry/docs/advanced-authentication[service account JSON key file].
Your JSON token blob will look something like this:
+
[source,yaml]
----
{
  "type": "service_account",
  "project_id": "my_project_id",
  "private_key_id": "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
  "private_key": "-----BEGIN PRIVATE KEY-----\nXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX==\n-----END PRIVATE KEY-----\n",
  "client_email": "XXXXXXXXXXXXXXX@XXXXXXXXXXXXXX.iam.gserviceaccount.com",
  "client_id": "XXXXXXXXXXXXXXXXXXXXXXXXX",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX.iam.gserviceaccount.com"
}
----

[.procedure]
. Open Console, then go to *Defend > Vulnerabilities > Registry*.

. Click *Add registry*.

. Enter the registry address in the *Registry* field (e.g. `gcr.io`).

. Enter the repository name followed by `/{asterisk}` in the *Repository* field (e.g. `company-sandbox/*`).

. Click in the *Credential* field, then click *Add new*.
+
image::scan_gcr_add_registry.png[width=800]

.. Select the *GCP* credential type, then paste the JSON token blob from your service account into the *Service Account* field.
Leave the *API Token* field blank.
+
image::scan_gcr_create_new_credential.png[width=800]

.. Save your credentials.

.. In *OS type*, specify whether the repo holds *Linux* or *Windows* images.

.. In *Scanners scope*, specify the collections of defenders to use for the scan.
+
Console selects the available Defenders from the scope to execute the scan job according to the *Number of scanners* setting.
For more information, see xref:../../vulnerability_management/registry_scanning.adoc#_deployment_patterns[deployment patterns].

.. In *Number of scanners*, enter the number of Defenders across which scan jobs can be distributed.

.. Set *Cap* to the number of most recent images to scan.
+
Leaving *Cap* set to *5* will scan the 5 most recent images.
Setting this field to *0* will scan all images.

.. Click *Add*.

. Click the *Save* button.


[.task]
=== Results

Verify that the images in the repository are being scanned.

[.procedure]
. Go to *Monitor > Vulnerabilities > Images > Registries*.
+
A progress indicator at the top right of the window shows the status of the current scan.
As the scan of each image is completed, its findings are added to the results table.

. To get details about the vulnerabilities in an image, click on it.
+
To force a specific repository to be scanned again, select *Scan* from the top right of the results table, then click on the specific registry to rescan.
