== Scan Images in Sonatype Nexus Registry

To scan a repository in Sonatype Nexus Registry, create a new registry scan setting.

[#nexus-repo-connector]
=== Prerequisites

* You have xref:../../install/deploy-defender/defender_types.adoc#[installed a Container Defender] somewhere in your environment.

* Configure the connector port for the Docker engine to connect to the Nexus registry.
+
NOTE: The Docker client needs the Docker registry exposed at the root of the host together with the port that it is accessing. Nexus offers several methods to overcome this limitation, one of which is the connector port method, which Prisma Cloud supports.

.. From the Nexus web portal, select the Administration screen.

.. Select the Nexus Repository.

.. Select *Online* to allow the Nexus repository to accept the incoming requests.

.. Configure the Docker repository connector to use an HTTP or HTTPS port.

+
image::./nexus-repo-connector.png[scale=30]

* The Defender can establish a connection with the Nexus registry over the connector port that you configured in the Nexus registry.
+
Ensure that the port is open for the image to be accessed successfully.

ifdef::prisma_cloud[]
* To view the registry scan results, you must have the Administrator role or a custom role with access to registry settings and ability to view the registry scan results.
endif::prisma_cloud[]

[.task]
[#add-nexus-registry]
=== Configure a Nexus Registry in Prisma Cloud

[.procedure]
. Log in to Console, and select *Compute > Defend > Vulnerabilities > Images > Registry settings*.

. Select *Add registry*.

. In the *Add New Registry Setting Specification*, enter the following values:

.. In the *Version* drop-down list, select *Sonatype Nexus*.

.. In *Registry*, enter the hostname, or Fully Qualified Domain Name (FQDN), and the connector port for the Nexus registry's login server.
+
The format for the FQDN is *<hostname>:<connector_port>*, where *<hostname>* is a unique value specified when the registry was created, and the *<connector_port>* is the one you configured in the Nexus repository administration.
+
Example: 
*<http|https://<nexus_hostname>:<HTTP/HTTPS connector port for the specific Nexus repo>*.
+
*https://ec2-100-25-223-135.compute-1.amazonaws.com:8083*

.. Leave the *Repository* blank or include a pattern to match the Docker repositories inside the Nexus registry.
+
For example: To scan all the images under a path, include the *path/to* string.

.. Optionally enter the Repositories to exclude them from being scanned.

.. In *Tag*, enter an image tag.
Leave this field blank to scan all images, regardless of their tag.

.. Optionally, enter Tags to exclude, to avoid scanning images with specified tags.

.. In *Credential*, configure how Prisma Cloud authenticates with Nexus registry.
+
Select a credential from the drop-down list.
+
If there are no credentials in the list, *Add* new credentials and select the Basic authentication.

.. You can optionally enter a custom *CA certificate* in PEM format for Prisma Cloud to validate the Nexus registry.
+
Custom CA certificate validation is supported only for non-Docker nodes (e.g. OpenShift).
+
NOTE: Ensure that the Custom CA certificate that you use is not revoked by the issuing authority.

.. In *OS type*, specify whether the repo holds *Linux* or *Windows* images.

.. In *Scanners scope*, specify the collections of defenders to use for the scan.
+
Console selects the available Defenders from the scope to execute the scan job according to the *Number of scanners* setting.
For more information, see xref:../../vulnerability_management/registry_scanning/configure_registry_scanning.adoc#_deployment_patterns[deployment patterns].

.. In *Number of scanners*, enter the number of Defenders across which scan jobs can be distributed.

.. In *Cap*, limit the number of images to scan.
+
Set *Cap* to *5* to scan the five most recent images, or enter a different value to increase or decrease the limit.
Set *Cap* to *0* to scan all images.

. Select *Add and scan*.
+
Verify that the images in the repository are being scanned under *Monitor > Vulnerabilities > Images > Registries*.

[.task]
=== Troubleshooting

*Prisma Cloud failed to pull images from the Nexus repository*

*Monitor > Vulnerabilities > Images > Registries* shows the following error:

`ERRO 2022-06-07T06:55:39.046 scanner.go:110 Failed to pull image cybersecurity/conjur/test-app:latest, error Error initializing source docker://nexus.nedigital.sg/cybersecurity/conjur/test-app:latest: error pinging docker registry nexus.nedigital.sg: invalid status code from registry 400 (Bad Request)`

image::./prisma-cloud-nexus-registry-error.png[scale=20]

[.procedure]
. Ensure that you have installed Defender on the host on which the Nexus registry is installed.
. Verify that you can https://help.sonatype.com/repomanager3/nexus-repository-administration/formats/docker-registry/pulling-images[pull the nexus registry] using the docker command.
. Create a Nexus repository connector port as mentioned in the <<nexus-repo-connector>>.
. <<add-nexus-registry>> using the connector port in the Registry URL.
