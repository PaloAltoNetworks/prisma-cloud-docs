== Sonatype Nexus Registry

To scan a repository in Sonatype Nexus Registry, create a new registry scan setting.

[#nexus-repo-connector]
=== Prerequisites

* You have xref:../../install/defender_types.adoc#[installed a Container Defender] somewhere in your environment. 

* Configure the connector port for the Docker engine to connect to the Nexus registry.
+
NOTE: The Docker client needs the Docker registry exposed at the root of the host together with the port that it is accessing. Nexus offers several methods to overcome this limitation, one of which is the connector port method, which Prisma Cloud supports.

.. From the Nexus web portal, select Administration screen.

.. Select the Nexus Repository.

.. Select *Online* to allow the Nexus repository to accept the incoming requests.

.. Configure the Docker repository connector to use an HTTP or HTTPS port.

.. Select *Allow anonymous docker pull* to grant permissions to the anonymous user per repository basis.
+
image::./nexus-repo-connector.png[width=300]

* The Defender can establish a connection with the Nexus registry over the connector port that you configured in the Nexus registry.
+
Ensure that the port is open for the image to be accessed successfully.

[.task]
[#add-nexus-registry]
=== Add a Nexus registry in Prisma Cloud

[.procedure]
. Log in to Console, and select *Compute > Defend > Vulnerabilities > Registry*.

. Select *Add registry*.

. In the *Add New Registry Setting Specification*, enter the following values:

.. In the *Version* drop-down list, select *Sonatype Nexus*.

.. In *Registry*, enter the hostname, or Fully Qualified Domain Name (FQDN), and the connector port for the Nexus registry's login server.
+
The format for the FQDN is *<hostname>:<connector_port>*, where *<hostname>* is a unique value specified when the registry was created, and the *<connectorl_port>* is the one you configured in the Nexus repository administration.
+
Example: 
*<http|https://<nexus_hostname>:<HTTP/HTTPS connector port for the specific Nexus repo>*.
+
*https://ec2-100-25-223-135.compute-1.amazonaws.com:8083*


.. Leave the *Repository* blank or include a pattern to match the Docker repositories inside the Nexus registry.
+
For example: To scan all the images under a path, include the *path/to* string.

.. In *Tag*, enter an image tag.
Leave this field blank to scan all images, regardless of their tag.

.. In *Credential*, configure how Prisma Cloud authenticates with Nexus registry.
+
Select a credential from the drop-down list.
+
If there are no credentials in the list, click *Add* to create new credentials. The repository connector also provides the option to configure anonymous authentication using the Docker Bearer Token Realm, if you have enabled the *Allow anonymous docker pull* on the Nexus administration page.
+

.. In *OS type*, specify whether the repo holds *Linux* or *Windows* images.

.. In *Scanners scope*, specify the collections of defenders to use for the scan.
+
Console selects the available Defenders from the scope to execute the scan job according to the *Number of scanners* setting.
For more information, see xref:../../vulnerability_management/registry_scanning.adoc#_deployment_patterns[deployment patterns].

.. In *Number of scanners*, enter the number of Defenders across which scan jobs can be distributed.

.. In *Cap*, limit the number of images to scan.
+
Set *Cap* to *5* to scan the five most recent images, or enter a different value to increase or decrease the limit.
Set *Cap* to *0* to scan all images.

.. Select *Add*.

. Select *Save and scan*.


[.task]
=== View Results

Verify that the images in the repository are being scanned.

[.procedure]
. Go to *Monitor > Vulnerabilities > Images > Registries*.
+
A progress indicator at the top right of the window shows the status of the current scan.
As the scan of each image is completed, the finding results display in the table.

. To get details about the vulnerabilities in an image, click on it.
+
To force a specific repository to be scanned again, select *Scan* from the top right of the results table, then click on the specific registry to rescan.

[.task]
=== Troubleshooting

*Prisma Cloud failed to pull images from the Nexus repository*

*Monitor > Vulnerabilities > Images > Registries* shows the following error:

`ERRO 2022-06-07T06:55:39.046 scanner.go:110 Failed to pull image cybersecurity/conjur/test-app:latest, error Error initializing source docker://nexus.nedigital.sg/cybersecurity/conjur/test-app:latest: error pinging docker registry nexus.nedigital.sg: invalid status code from registry 400 (Bad Request)`

image::./prisma-cloud-nexus-registry-error.png[width=300]

[.procedure]
. Ensure that you have installed Defender on the host on which the Nexus registry is installed.
. Verify that you can https://help.sonatype.com/repomanager3/nexus-repository-administration/formats/docker-registry/pulling-images[pull the nexus registry] using the docker command.
. Create a Nexus repository connector port as mentioned in the <<nexus-repo-connector>>.
. <<add-nexus-registry>> using the connector port in the Registry URL.
