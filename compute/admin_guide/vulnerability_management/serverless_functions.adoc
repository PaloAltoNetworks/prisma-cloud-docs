== Serverless function scanning

Prisma Cloud can scan serverless functions for vulnerabilities.
Prisma Cloud supports AWS Lambda, Google Cloud Functions, and Azure Functions.

Serverless computing is an execution model in which a cloud provider dynamically manages the allocation of machine resources and schedules the execution of functions provided by users.
Serverless architectures delegate the operational responsibilities, along with many security concerns, to the cloud provider. In particular, your app itself is still prone to attack.
The vulnerabilities in your code and associated dependencies are the footholds attackers use to compromise an app.
Prisma Cloud can show you a function's dependencies, and surface the vulnerabilities in those dependent components.


[.section]
=== Capabilities

For serverless, Prisma Cloud can scan Node.js, Python, Java, C#, Ruby, and Go packages.
For a list of supported runtimes see xref:../install/system_requirements.adoc[system requirements].

Prisma Cloud scans are triggered by the following events:

* When the settings change, including when new functions are added for scanning.
* When you explicitly click the *Scan* button in the *Monitor > Vulnerabilities > Functions > Scanned Functions* page.
* Periodically.
By default, Prisma Cloud rescans serverless functions every 24 hours, but you can configure a custom interval in *Manage > System > Scan*.


[.task]
=== Scanning a serverless function

Configure Prisma Cloud to periodically scan your serverless functions.
Unlike image scanning, all function scanning is handled by Console.

[.procedure]
. Open Console.

. Go to *Defend > Vulnerabilities > Functions > Functions*.

. Click on *Add scope*. In the dialog, enter the following settings:

.. (AWS only) Select *Scan only latest versions* to only scan the latest version of each function.
Otherwise, the scanning will cover all versions of each function up to the specified *Limit* value. 

.. (AWS only) Select *Scan Lambda Layers* to enable scanning function layers as well.

.. (AWS only) Specify which regions to scan in *AWS Scanning scope*.
By default, the scope is applied to *Regular regions*.
Other options include *China regions* or *Government regions*.

.. Specify a *Limit* for the number of functions to scan.
+
NOTE: Prisma Cloud scans the X most recent functions, where X is the limit value.
Set this value to '0' to scan all functions.
+
NOTE: For scanning Google Cloud Functions with GCP organization level credentials, the limit value is for the entire organization. Increase the limit as needed to cover all the projects within your GCP organization.

.. Select the accounts to scan by credential.
If you wish to add an account, click on *Add credential*.
+
NOTE: For Azure: if you create a credential in the credentials store (*Manage > Authentication > Credentials store*), your service principal authenticates with a password.
To authenticate with a certificate, xref:../authentication/cloud_accounts.adoc[create a cloud account].

.. Click *Add*.

. Click the green save button.

. View the scan report.
+
Go to *Monitor > Vulnerabilities > Functions > Scanned functions*.

+
All vulnerabilities identified in the latest serverless scan report can be exported to a CSV file by clicking on the CSV button in the top right of the table.


[.task]
=== View AWS Lambda Layers scan report

Prisma Cloud can scan the AWS Lambda Layers code as part of the Lambda function's code scanning.
This capability can help you determine whether the vulnerability issues are associated with the function or function Layers.
Follow the steps below to view the Lambda Layers scan results:

[.procedure]
. Open Console.

. Make sure you selected the *Scan Lambda layers* in the Defend > Vulnerabilities > Functions > Functions > Serverless Accounts > *Function scan scope*
+
image::function_scan_scope.png[width=700]

. Go to *Monitor > Vulnerabilities > Functions > Scanned functions*.

. Filter the table to include functions with the desired Layer by adding the *Layers* filter.
+
You can also filter the results by a specific layer name or postfix wildcards.
Example: `Layers:* OR Layers:arn:aws:lambda:*`
+
image::function_vuls_layers_filter.png[width=700]

. Open the *Function details* dialog to view the details about the Layers and the vulnerabilities associated with them:

.. Click on a specific function

.. See the Function's vulnerabilities, compliance issues and package info in the related tabs. Use the *Found in* column to determine if the component is associated with the Function or with the Function's Layers.
+
image::vul_function_details.png[width=700]

.. Use the *Layers info* tab to see the full list of the Function's Layers, and aggregated information about the Layers vulnerabilities. In case that there are vulnerabilities associated with the layer you will be able to expand the layer raw to list all the vulnerabilities.
+
image::vuls_functions_layers_info.png[width=700] 


=== Authenticating with AWS

The serverless scanner is implemented as part of Console.
The scanner requires the following permissions policy:
+
[source,json]
----
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PrismaCloudComputeServerlessScan",
            "Effect": "Allow",
            "Action": [
                "lambda:ListFunctions",
                "lambda:GetFunction",
                "iam:GetPolicy",
                "iam:GetPolicyVersion",
                "iam:GetRole",
                "iam:GetRolePolicy",
                "iam:ListAttachedRolePolicies",
                "iam:ListRolePolicies",
                "lambda:GetLayerVersion",
                "kms:Decrypt"
            ],
            "Resource": "*"
        }
    ]
}
----


*IAM User*

If authenticating with an IAM user, use the Security Token Service (STS) to temporarily issue security credentials to Prisma Cloud to scan your Lambda functions.
AWS STS is considered a best practice for IAM users per the AWS Well-Architected Framework.
For more on how to use AWS STS, see xref:../authentication/credentials_store.adoc#_aws_security_token_service_sts[here].

When authenticating with an IAM user, Console can access and scan functions across multiple regions.

*IAM Role*

ifdef::compute_edition[]
The Prisma Cloud serverless scanner can also authenticate with AWS using an IAM role.
If Console authenticates with AWS using an IAM role, it can assume roles using STS to assume roles in other regions.
endif::compute_edition[]

ifdef::prisma_cloud[]
IAM roles cannot be used in Prisma Cloud serverless scanning as the Console is not hosted within AWS for Enterprise Edition.
endif::prisma_cloud[]

[.task]
=== Scanning Azure Functions

Azure Functions are architected differently than AWS Lambda and Google Cloud Functions. 
Azure function apps can hold multiple functions.
The functions are not segregated from each other.
They share the same file system.
Rather than separately scanning each function in a function app, download the root directory of the function app, which contains all its functions, and scan them as a bundle.

NOTE: Prisma Cloud supports scanning both Windows and Linux functions. For Linux functions, the support is only for functions that use *External package URL* as the deployment technology.
For more information, see https://docs.microsoft.com/en-us/azure/azure-functions/functions-deployment-technologies[Deployment technologies in Azure Functions].

To do this, you must know the Region, Name (of the function), and Service Key.
To get the Service Key, download and https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest[install the Azure CLI], then:

[.procedure]
. Within your Azure portal, create a custom role with the following permissions:
   
    {
        "permissions": [
            {
                "actions": [
                    "Microsoft.Web/sites/Read",
                    "Microsoft.Web/sites/config/list/Action",
                    "Microsoft.web/sites/functions/action",
                    "Microsoft.web/sites/functions/read",
                    "Microsoft.Web/sites/publishxml/Action"
                ],
                "notActions": [],
                "dataActions": [],
                "notDataActions": []
            }
        ]
    }

. Using the CLI, log into your account with a user that has the https://docs.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#user-administrator[User Administrator] role.

  $ az login

. Get the service key.

 $ az ad sp create-for-rbac --sdk-auth --name twistlock-azure-serverless-scanning --role CUSTOM_ROLE_NAME
+
Sample output from the previous command:
+
  {
    "clientId": "f8e9de2o-45bd-af94-ae11-b9r8c5tfy3b6",
    "clientSecret": "4dfds482-6sdd-4dsb-b5ff-56123043c4dc",
    "subscriptionId": "ea19322m-z2bd-501c-dd11-234m547a944e",
    "tenantId": "c189c61a-6c27-41c3-9949-ca5c8cc4a624",
    "activeDirectoryEndpointUrl": "https://login.microsoftonline.com",
    "resourceManagerEndpointUrl": "https://management.azure.com/",
    "activeDirectoryGraphResourceId": "https://graph.windows.net/",
    "sqlManagementEndpointUrl": "https://management.core.windows.net:8443/",
    "galleryEndpointUrl": "https://gallery.azure.com/",
    "managementEndpointUrl": "https://management.core.windows.net/"
  }

. Copy the JSON output, which is your secret key, and paste it into the *Service Key* field for your Azure credentials in Prisma Cloud Console.


=== Scanning Google Cloud Functions

To scan Google Cloud Functions, you must create an appropriate xref:../authentication/credentials_store.adoc#google-cloud-platform-gcp[credential] to authenticate with GCP. The service account should include the following custom permissions:

[source]
----
cloudfunctions.functions.sourceCodeGet
cloudfunctions.functions.get
cloudfunctions.functions.list
cloudfunctions.functions.update
cloudfunctions.locations.get
cloudfunctions.locations.list
cloudfunctions.operations.get
cloudfunctions.operations.list
cloudfunctions.runtimes.list
----

=== Scanning functions at build time with twistcli

You can also use the `twistcli` command line utility to scan your serverless functions.
First download your serverless function as a ZIP file, then run:
 
  $ twistcli serverless scan <SERVERLESS_FUNCTION.ZIP>
  
To view scan reports in Console, go to *Monitor > Vulnerabilities > Functions > CI* or *Monitor > Compliance > Functions > CI*.

==== Twistcli Options

ifdef::prisma_cloud[]
`--address` [.underline]#`URI`#::
Required.
Complete URI for Console, including the protocol and port.
Only the HTTPS protocol is supported.
+
Example: --address https://https://us-west1.cloud.twistlock.com/us-3-123456789

To get the address for your Console, go to *Compute > Manage > System > Utilities*, and copy the string under *Path to Console*.

`-u`, `--user` [.underline]#`Access Key ID`#::
_Access Key ID_ to access Prisma Cloud. 
If not provided, the `TWISTLOCK_USER` environment variable is used, if defined.
Otherwise, "admin" is used as the default.

`-p`, `--password` [.underline]#`Secret Key`#::
_Secret Key_ for the above _Access Key ID_ specified with `-u`, `--user`.
If not specified on the command-line, the `TWISTLOCK_PASSWORD` environment variable is used, if defined.
Otherwise, you will be prompted for the user's password before the scan runs.

_Access Key ID_ and _Secret Key_ are generated from the Prisma Cloud user interface.
For more information, see xref:../authentication/access_keys.adoc[access keys]

endif::prisma_cloud[]


ifdef::compute_edition[]
`--address` [.underline]#`URI`#::
Required.
Complete URI for Console, including the protocol and port.
Only the HTTPS protocol is supported.
By default, Console listens to HTTPS on port 8083, although your administrator can configure Console to listen on a different port.
+
Example: --address https://console.example.com:8083

`-u`, `--user` [.underline]#`USERNAME`#::
Username to access Console.  If not provided, the `TWISTLOCK_USER` environment variable will be used if defined, or "admin" is used as the default.

`-p`, `--password` [.underline]#`PASSWORD`#::
Password for the user specified with `-u`, `--user`.
If not specified on the command-line, the `TWISTLOCK_PASSWORD` environment variable will be used if defined, or otherwise will prompt for the user's password before the scan runs.

`--project` [.underline]#`PROJECT NAME`#::
Interface with a specific supervisor Console to retrieve policy and publish results.
+
Example: --project "Tenant Console"
endif::compute_edition[]

`--details`::
Show all vulnerability details.

`--tlscacert` [.underline]#`PATH`#::
Path to Prisma Cloud CA certificate file.
If no CA certificate is specified, the connection to Console is insecure.

`--include-js-dependencies`::
Include javascript package dependencies.

`--token` [.underline]#`TOKEN`#::
Token to use for Prisma Cloud Console authentication.
Tokens can be retrieved from the API endpoint _api/v1/authenticate_ or from the *Manage > Authenticate > User Certificates* page in Console.

`--cloudformation-template` [.underline]#`PATH`#::
Path to the CloudFormation template file in JSON or YAML format. Prisma Cloud scans the function source code for AWS service APIs being used, compares the APIs being used to the function permissions, and reports when functions have permissions for APIs they don't need.

`--function` [.underline]#`NAME`#::
Function name to be used in policy detection and Console results. When creating policy rules in Console, you can target specific rules to specific functions by function name. If this field is left unspecified, the function zip file name is used.

`--output-used-apis`::
Report APIs used by the function

`--publish`::
Publish the scan result to the Console.  True by default.
