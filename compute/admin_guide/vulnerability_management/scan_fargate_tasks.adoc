== Scan Fargate tasks

AWS Fargate is a serverless compute engine for containers under Amazon ECS that lets you run containers without needing to provision and manage servers and hosts.
Each container is defined as part of a task and several containers can be run as part of the same task. 

Prisma Cloud can scan your Fargate tasks for image vulnerabilities.
To see the scan report for your Fargate task images, go to *Monitor > Vulnerabilities > Images* and filter the table with *Fargate:Select*.

Prisma Cloud Compute labels all containers running within the same task as if they run on the same host.
For containers that are running in Fargate, the Host column will contain the Fargate task identifier.


[.task]
=== Create vulnerability rules to scan Fargate tasks

Create a vulnerability rule for Fargate tasks in scope.

[.procedure]
. Login to the Console.

. Go to *Defend > Vulnerabilities > Images > Deployed*.

. Click *Add rule*.

. Entar a rule name.

. Click on *Scope*, to select a relevant collection, or create a new one for your Fatgate tasks:

.. Click *Add collection*.

.. Enter collection name.

.. In the host you can type the name of the required Fargate task name or postfix wildcards.
+
For example `fargate`, `fargate-vulnerability-compliance-task`.

.. Click *Save*.

.. Select the new fargate task collection.

.. Click *Select collection*.

. Click *Save*.
+
NOTE: Block action doesn't apply to Fargate tasks.
+
image::fargate_collection_image.png[width=600]


=== Deploy Fargate task

Deploy the `fargate-vulnerability-compliance-task` fargate tesk (described below), following the steps in xref:../install/install_defender/install_app_embedded_defender_fargate.adoc[Embed App-Embedded Defender into Fargate tasks].

==== Example Fargate task

You can use the following task definition to test Prisma Cloud's Fargate Defender.
The task deploys a `ubuntu:18.04` container and runs the `/bin/sh -c 'cp /bin/sleep /tmp/xmrig` command that triggers the "Image contains binaries used for crypto mining" compliance check.

[source,json]
----
{
  "containerDefinitions": [
     {
        "command": [
           "/bin/sh -c 'cp /bin/sleep /tmp/xmrig && echo \"[+] Sleeping...\" && while true; do sleep 1000 ; done'"
        ],
        "entryPoint": [
           "sh",
           "-c"
        ],
        "essential": true,
        "image": "ubuntu:18.04",
        "logConfiguration": {
           "logDriver": "awslogs",
           "options": {
              "awslogs-group" : "/ecs/fargate-task-definition",
              "awslogs-region": "us-east-1",
              "awslogs-stream-prefix": "ecs"
           }
        },
        "name": "Fargate-vul-comp-test",
        "portMappings": [
           {
              "containerPort": 80,
              "hostPort": 80,
              "protocol": "tcp"
           }
        ]
     }
  ],
  "cpu": "256",
  "executionRoleArn": "arn:aws:iam::012345678910:role/ecsTaskExecutionRole",
  "family": "fargate-vulnerability-compliance-task",
  "memory": "512",
  "networkMode": "awsvpc",
  "requiresCompatibilities": [
      "FARGATE"
   ]
}
----

[.task]
=== View vulnerability scan results

View the scan results in Console.

NOTE: If a Fargate task is run with a container where the user is not root, the vulnerability and compliance scanning procedure will encounter permission denied errors that are not visible to the user unless the Defender logs are downloaded.
The scan flow continues even though errors are encountered.

[.procedure]
. Navigate to *Monitor > Vulnerabilities > Images > Deployed* and validate that the deployed image appears and contains vulnerabilities.

. To see all images that are related to Fargate tasks, filter the image table by adding the *Fargate:Select* filter.
You can also filter the results by a specific task name or postfix wildcards, example: `fargate-task` OR `fargate-task*`.
Use the *Hosts:* filter to filter the table specifically by hosts.
+
image::fargate_select_filter_vul.png[width=600]

. Search for the `fargate-vulnerability-compliance-task` Fargate task.

. Click on the image to view image details.

.. The associated vulnerabilities will appear under the Vulnerabilities tab

.. Under the Compliance tab, see the following compliance issue: Image contains binaries used for crypto mining

.. See the related Fargate tasks under the *Environment > Fargate Tasks* tab 
+
NOTE: the Host column represents the number of hosts and Fargate tasks that this image is associated with.
+
NOTE: Runtime, Layers, Processes info and Labels tabs are not supported for images scanning by Fargate defenders.
+
image::fargate_image_scan_result.png[width=600]
