== Configure Agentless Scanning

Agentless scanning provides visibility into vulnerabilities and compliance risks on hosts by scanning the root volumes of snapshots.
The agentless scanning architecture lets you inspect a host without having to install an agent or affecting its execution.
To learn more about the architecture and scan results, see xref:../vulnerability_management/agentless_scanning.adoc[agentless scanning].

=== Prerequisites

To configure agentless scanning for a cloud account, you must ensure the following requirements are met.

ifdef::prisma_cloud[]

If you are importing Cloud Account credentials from the Prisma Cloud platform:

* You have added your https://docs.paloaltonetworks.com/prisma/prisma-cloud/prisma-cloud-admin/connect-your-cloud-platform-to-prisma-cloud[AWS, Azure, or GCP account to Prisma Cloud], and selected *Monitor and Protect* mode.
* If you have an existing cloud account added to Prisma Cloud using the *Monitor* mode, you have updated it to use the *Monitor and Protect* mode.
* If you have an existing cloud account using *Monitor and Protect* that was added before June 2022, you have updated its CFT with the https://cdn.twistlock.com/docs/downloads/Agentless_Permissions.pdf[full permission list].
* You have enabled auto-assign public IPs on the subnet or security group used to connect your cloud account to the Prisma Cloud Console.

If you are adding Cloud Account credentials:

endif::prisma_cloud[]

* You can create resources in your cloud account.
* You can apply agentless permission templates to your cloud account.
* You can connect from your cloud account to the Prisma Cloud Console. Unless you are using a proxy to connect to the Prisma Cloud Console, you must enable auto-assign public IPs on the subnet or security group you use to connect your cloud account to the Prisma Cloud Console.

To review the permissions required for agentless scanning, refer to the https://cdn.twistlock.com/docs/downloads/Agentless_Permissions.pdf[full permission list]. 
The permissions templates downloaded from the Prisma Cloud Console add conditions to these permissions to ensure least-privileged roles in your cloud accounts. 

[#_individual-account]
[.task]
=== Configure Agentless Scanning

The following procedure shows the steps required to configure agentless scanning for a cloud account.

[.procedure]
. Go to *Compute > Manage > Cloud accounts*.
+
image::manage-cloud-accounts.png[width=800]

. Click on *Add Account* or click the *Edit* icon of an existing account.

. Select your cloud provider and configure its xref:../authentication/credentials_store.adoc[credentials].
+
image::set-credentials.png[width=800]

.. AWS uses an https://aws.amazon.com/premiumsupport/knowledge-center/create-access-key/[access key with a secret key]
.. Azure uses a https://docs.microsoft.com/en-us/cli/azure/create-an-azure-service-principal-azure-cli[service principal]
.. GCP uses a https://cloud.google.com/iam/docs/creating-managing-service-accounts[service account] and a https://cloud.google.com/iam/docs/creating-managing-service-account-keys[service account key].

. If you are adding Cloud Account credentials, click the *Download* button to download its permission templates. Prisma Cloud validates the specified credentials: if the credentials are incorrect, the download raises an error.
To understand more about the downloaded template files and how they are used, refer to the xref:./agentless-permission-templates.adoc[permission templates document]
+
image::agentless-permission-templates.png[width=500]

. Review the default configuration values and make any needed changes.
+
image::agentless-configuration-aws.png[width=800]

.. *Console URL and Port:* Specify the Prisma Cloud Console URL and port that you will use to connect your cloud account to the Prisma Cloud Console.

.. *Scanning type:*  
... *Same Account:* Scan hosts of a cloud account using the same cloud account. 
... *Hub Account:* Scan hosts of a cloud account (the target account) using another cloud account (the hub account).
+ 
For a detailed instructions for each of the scanning modes and their corresponding permission templates, refer to the xref:_scanning-modes[Scanning Modes].

.. *HTTP Proxy:* To connect to the Prisma Cloud Console through a proxy, specify its URL.

.. *Regions:* Specify the regions to be scanned.

.. *Exclude VMs by tags:* Specify the tags used to ignore specific hosts. For example: `example:tag`

.. *Scan non running hosts:* Enable to scan stopped hosts, that are not currently running.

.. *Auto-scale scanning:* When turned ON, Prisma Cloud automatically scales up / down multiple scanners for faster scans without any user-defined limits. Useful for large scale deployments.

.. *Number of scanners:* Define an upper limit to control the number of scanners Prisma Cloud can automatically spin up in your environment. Depending on the size of your environment, Prisma cloud will scale up / down scanners within the given limit for faster scans. 

.. *Security groups:*

... *AWS:* Security group - If blank, Prisma Cloud uses the _default_ security group to connect to the Prisma Cloud Console. If the default is not available, create and specify a custom security group; otherwise, the connection from your account to the Prisma Cloud Console fails and no scan results are shown.
... *Azure:* Security Group ID and Subnet ID - If blank, a security group and subnet are created automatically to connect to the Prisma Cloud Console; otherwise, you can specify a custom security group ID and subnet ID. 
... *GCP:* Subnet - If blank, Prisma Cloud uses the _default_ subnet in your project to connect to the Prisma Cloud Console. If the default is not available, create and specify a custom subnet; otherwise, the connection from your project to the Prisma Cloud Console fails and no scan results are shown.
+

. Enable or disable the *Discovery features* using the corresponding toggle.

. To complete the configuration, click the *Add account* button for new cloud accounts or the *Save* button for existing cloud accounts.
+
image::save-agentless-configuration.png[width=800]

ifdef::prisma_cloud[]

=== Default Configuration Fields

The following list shows the default values for agentless configuration, and those imported from the platform.

. *Console URL and Port:* (automatically imported by the platform)
. *Scanning type:* Same Account
. *Scan Scope:* All regions
. *Scan non running hosts:* OFF
. *Auto-scale scanning:* OFF
. *Number of scanners:* 1
. *Security groups:*
.. *AWS:* Prisma Cloud uses the _default_ security group to connect to the Prisma Cloud Console.
.. *Azure:* Prisma Cloud automatically creates a security group to connect to the Prisma Cloud Console.
.. *GCP:* Prisma Cloud uses the _default_ subnet to connect to the Prisma Cloud Console.

You can change default values after importing Cloud Account credentials into Compute using the *Edit* icon for the specific account, or by selecting multiple accounts and clicking on *Bulk actions*.

endif::prisma_cloud[]

[#_scanning-modes]
=== Scanning Modes

The following modes are available for agentless scanning in Prisma Cloud.

* *Same Account Mode*: Scan hosts of the cloud account using the same cloud account. This mode spins up temporary scanning instances in the account.

* *Hub Account Mode* Scan hosts of the cloud account (the target) using another cloud account (the hub). This mode spins up temporary scanning instances in the hub rather than in the target(s).

==== AWS

When you click the *Download* button, multiple permission templates are downloaded as JSON files.
These templates support the various permissions required by each of the cloud accounts for each of the scanning modes.

===== Same Account Mode

To scan accounts using this mode, download and apply the permission template that ends in `_target_user_permissions.json` to the AWS cloud account.

===== Hub Account Mode

You first configure and select a cloud account to serve as the hub account.
You apply permissions templates from the hub account in Prisma Cloud to the hub account in AWS, and apply permissions templates from both the hub account and the target account in Prisma Cloud to the target account in AWS.

====== Hub Account

To use an account as a hub account, first add it to Cloud Accounts, downloading and applying the permission template that ends in  `_hub_user_permissions.json` to that hub account in AWS.

====== Target Account

Download and apply the permission template that ends in  `_hub_target_user_permissions.json` to that target account in AWS..

==== Azure

Download and apply the permission template to the Azure cloud account: there is no option for Hub Account Mode in Aure.
Note that Prisma Cloud creates a dedicated `PCC` resource group to allow for easier cost calculations.

==== GCP

When you click the *Download* button, multiple permission templates are downloaded as JINJA files.
These templates support the various permissions required by each of the cloud accounts for each of the scanning modes.

===== Same Account Mode

To scan accounts using this mode, download and apply the permission template that ends in `_target_user_permissions.yaml.jinja` to the GCP project.

===== Hub Account Mode

You first configure and select an cloud account to serve as the hub account.
You apply permissions templates from the hub account in Prisma Cloud to the hub project in GCP, and apply permissions templates from both the hub account and the target account in Prisma Cloud to the target project in GCP.

====== Hub Account/Project

To use an account as a hub account, first add it to Cloud Accounts, downloading and applying the permission template that ends in `_hub_user_permissions.yaml.jinja` to that hub project in GCP.

To also allow that hub account to scan its own hosts, also apply the permission template that ends in `_target_user_permissions.yaml.jinja` to that hub project in GCP.
Otherwise, disable Agentless scanning for that hub account in Cloud Accounts.

===== Target Account/Project

Download and apply the permission templates that end in `_hub_target_user_permissions.yaml.jinja` and `_hub_target_access_permissions.yaml.jinja` to the target project in GCP.

[#_multiple-accounts]
[.task]
=== Bulk Actions

Prisma Cloud supports performing agentless configuration at scale.
Different cloud providers and authentication subtypes require different configuration fields, which also limits your ability to change accounts in bulk.
The Prisma Cloud Console displays all the configuration fields that can be changed across all the selected accounts, and hides those that differ to prevent accidental misconfiguration.

The following procedure shows the steps needed to configure agentless scanning for multiple accounts at the same time.

[.procedure]
. Go to *Manage > Cloud accounts*
+
image::manage-cloud-accounts.png[width=800]

. Select multiple accounts.
+
[Note]
====
Only select accounts from the same cloud provider and of the same authentication subtype.
If you select accounts from different providers, you can't change agentless configuration fields.
====

. Click the *Bulk actions* dropdown.

. Select the *Agentless configuration* button.
+
image::bulk-actions.png[width=400]

. Change the configuration values for the selected accounts.
+
image::agentless-configuration-bulk.png[width=800]

* Select *Save* to save the configuration for the selected accounts.

=== Other Settings

Use the *Cloud Account Manager* user role to grant full read and write access to all cloud account settings.
This role can manage credentials, and change Agentless scanning and Cloud discovery configuration.

By default, agentless scans are performed every 24 hours, but you can change the interval on the *Manage > System > Scan* page under *Scheduling > Agentless*.

image::agentless-interval.png[width=800]

To manually trigger an agentless scan, click the *Trigger scan* dropdown and select the *Start agentless scan* option on the *Manage > Cloud accounts* page.

image::trigger-scan.png[width=400]
