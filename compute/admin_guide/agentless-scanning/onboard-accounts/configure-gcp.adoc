:toc: macro
:topic_type: task
[#configure-gcp-agentless]
[.task]
== Configure Agentless Scanning for GCP

toc::[]

ifdef::prisma_cloud[]
[.procedure]
. Log in to the Prisma Cloud administrative console.

. Select *Compute > Manage > Cloud Accounts*.

. Click the edit button of your cloud account.

. Go to the *Agentless Scanning* section.

endif::prisma_cloud[]

ifdef::compute_edition[]
[.procedure]
. Log in to your Prisma Cloud Compute Console.

. Go to *Manage > Cloud* Accounts.

. Click *+Add account*.
+
image::agentless-add-account.png[width=400]

. Enter the following information for the hub account in the *Account config* page.
+
image::agentless-gcp-account-config.png[width=400]

.. *Select Cloud provider*: GCP

.. *Account ID:* Enter your Google project ID for the hub account.

.. *Description:* Provide an optional string.

.. *Service account:* Paste the contents of the downloaded service account key file for the hub account.

.. *API token:* Leave blank.

. Click *Next*.

. In the Agentless scanning page, complete the following steps.

.. Enable *Agentless scanning*.

.. Set the *Console URL* and *Port* to the address of your Prisma Cloud console that can be reached from the internet. To create an address or FQDN reachable from the internet, complete the xref:../../configure/subject_alternative_names.adoc[Subject Alternative Names procedure].

endif::compute_edition[]

. *Hub account*: Enable the toggle to configure the account as a xref:../agentless-scanning-modes.adoc[hub account].

. Expand the *Advanced settings*
+
image::agentless-gcp-pcee-advanced-settings.png[width=540]

.. *Select where to scan*: For GCP accounts, you can decide between xref:../agentless-scanning.adoc#scanning-modes[two scanning modes].

... *Same Account*: Perform the agentless scanning process using this account.

... *Hub Account*: Perform the agentless scanning process using a centralized hub account. Select another account from the list to use as the centralized hub account to scan this account.

.. *Auto-scale scanning*: Automatically create the required amount of scanners to scan all of the hosts within a region, up to a limit of 50 scanners. To use a different limit specify the *Max number of scanners*.

.. *Max number of scanners*: Enter the upper limit of scanners that Prisma Cloud can automatically spin up in your environment for faster results.

.. *Enforce permissions check*: If the needed permissions aren't in place, this account won't be scanned. If this is a hub account, its target accounts also won't be scanned.

.. Enter a *Proxy* value if traffic leaving your GCP tenant uses a proxy.

.. *Custom tags*: Apply custom tags to any resources Prisma Cloud creates during agentless scanning.

.. Under *Scan scope* you can refine the scope of the scanning by *Regions* or using tags.
+
image::tags-scope.png[width=300]

... Choose *All regions* to scan in all GCP regions.
If you choose *Custom regions*, enter the GCP regions in which you want Prisma Cloud to scan.

... Choose whether or not to *Scan non running hosts*.

... Choose whether to *Exclude hosts by tags* or to *Include hosts by tags*.
You can use wildcards to specify a range of tags in both keys and values following these examples:
+
[source]
----
"abcd*"
"*abcd"
"abcd"
"*"
"*abcd*"
----

.. *Network resources*: Configure custom network resources for agentless scanning

... *Subnet*: If blank, the agentless scanner uses the `default` subnet in your project to connect to the Prisma Cloud Console. Don't use a default subnet or specify a custom subnet that's provided by a Shared VPC. If you are using a shared VPC, enter the shared VPC path in this field with the following convention. Go to the GCP documentation to https://cloud.google.com/vpc/docs/shared-vpc[learn more about shared VPCs]. Replace `{host_project_name}` with the ID of the project that owns the shared VPC.
+
[source]
----
projects/{host_project_name}/regions/{region_name}/subnetworks/{subnet_name}
----

. Click Next.

. Leave the *Discovery features* unchanged.

. Click *Save* to return to *Compute > Manage > Cloud accounts*.

=== Scan Encrypted Volumes When Using Hub Mode

When you use xref:../agentless-scanning-modes.adoc[hub and target projects], you can configure your hub project to access the encrypted volumes of the target accounts.
To use encrypted volumes the service account of Google Compute Engine needs to have the `cloudkms.cryptoKeyEncrypterDecrypter` role.
Without it, the service agent of the the hub project can't access the KMS keys.

The Compute Engine service agent for your hub project is labeled with the following convention.
`service-PROJECT_NUMBER@compute-system.iam.gserviceaccount.com`
Replace `PROJECT_NUMBER` with the number of your hub project.

Use the following command to apply the grant the role and permissions to the Compute Engine service agent.

[source]
----
gcloud projects add-iam-policy-binding KMS_PROJECT_ID \
    --member serviceAccount:service-PROJECT_NUMBER@compute-system.iam.gserviceaccount.com \
    --role roles/cloudkms.cryptoKeyEncrypterDecrypter
----

Replace `KMS_PROJECT_ID` with any project you need to use.
The KMS project isn't required to be the hub account or the target accounts you wish to scan.

include::frag_start-agentless-scan.adoc[leveloffset=1]
