== Deploying WAAS

WAAS (Web-Application and API Security) can secure both containerized and non-containerized web applications.
To deploy WAAS, create a new rule, and declare the entity to protect. 

Although the deployment method varies slightly depending on the type of entity you're protecting, the steps, in general, are:

. Define rule resource.
. Define application scope.
. Enable relevant protections.


=== Understanding WAAS rule resources and application scope

The WAAS rule engine is designed to let you tailor the best-suited protection for each part of your deployment. Each rule has two scopes:

* Rule resources.
* Application list.


==== Rule Resources

This scope defines, for each type of deployment, a combination of one or more elements to which WAAS should attach itself in order to protect the web application:

* *_For containerized applications_* - Containers, images, namespaces, cloud account IDs, hosts. 
* *_For non-containerized applications_* - Host on which the application is running.
* *_For containers protected with App-Embedded Defender_* - App ID.
* *_For serverless functions_* - Function name.

NOTE: In the event of scope overlap (when multiple rules are applied to the same resource scope), the first rule by order will apply and all others will not apply. You can reorder rules via the `Order` column in WAAS rule tables by dragging and dropping rules.

==== Application List

This scope defines the protected application's endpoints within the deployment as a combination of one or more of the following:

* *_Port (Required)_* - For containerized applications, the internal port on which the application is listening. For all other types, the externally facing port.
* *_HTTP hostname_* - Default setting is set to `*` (wildcard indicating all hostnames)
* *_Base path_* - Lets you apply protection policy on certain paths of the application (e.g. "/admin", "/admin/*", etc.)
* *_TLS_* - TLS certificate to be used when expecting encrypted inbound traffic.

To better illustrate, consider the following deployment scenario for a web application running on-top of an NGINX cluster:

image::cnaf_deployment_example.png[width=650]

In this example, different policies apply for different parts of the application.
The steps for deploying a WAAS rule to protect the above described web application would be as follows:

. *Define rule resources* - Specify the resource collection the rule applies to. Collections are comprised of image names and one or more elements to which WAAS should attach itself in order to protect the web application. In the following example, the rule will apply to all containers created by the nginx image. 
+
image::waas_nginx_scope.png[width=550]

. *Define protection policy for 'login', 'search' and 'product' endpoints* - Set OWASP Top 10 protection to "Prevent" and geo-based access control to "Alert".

. *Define protection policy for the application's API endpoints* - Set OWASP Top 10 and API protection to "Prevent" and HTTP header-based access control to "Alert".

Once the policy is defined, the rule overview shows the following rule resource and application definitions:

image::waas_rule_example.png[width=650]

* *_Rule Resources_* - Protection is applied to all NGINX images
* *_Apps List_* - We deployed two policies each covering a different endpoint in the application (defined by HTTP hostname, port and path combinations)


==== Protection evaluation flow

WAAS offers a range of protection targeted at different attack vectors.
Requests inspected by WAAS will be inspected in the following order of protections:

* Bot protection
* App firewall (OWASP Top-10)
* API protection 
* DoS protection

WAAS will continue to inspect a request until "Prevent" or "Ban" actions are triggered, at which point the request will be blocked, and the evaluation flow will be halted.

For instance, assume all protections in bot protection are set to "Prevent". An incoming request originating from a bot and containing a SQL injection payload would be blocked by the bot protection (since it precedes the app firewall in the evaluation flow), and the SQL injection payload will not be assessed by the app firewall.

In a different scenario, suppose that all bot protections are set to "Alert" and all app firewall protections are set to "Prevent". A request originating from a bot containing a command injection payload will generate an alert event by bot protection and will be blocked by the app firewall protection.

[#connectivity_monitor]

=== WAAS connectivity monitor

xref:../waas-intro.adoc[WAAS] connectivity monitor monitors the connection between WAAS and the protected application.

WAAS connectivity monitor aggregates data on pages served by WAAS and the application responses.

In addition, it provides easy access to WAAS related errors registered in the Defender logs (Defenders sends logs to the Console every hour).

The monitor tab becomes available when you click on an image or host protected by xref:../waas-intro.adoc[WAAS]. 

image::waas_radar_monitor.png[width=1000]

* *Last updated* - Most recent time when WAAS monitoring data was sent from the Defenders to the Console (Defender logs are sent to the Console on an hourly basis). By clicking on the *refresh* button users can initiate sending of newer data.

* *Aggregation start time* - Time when data aggregation began. By clicking on the *reset* button users can reset all counters.

* *WAAS errors* - To view recent errors related to a monitored image or host, click the *View recent errors* link.

* *WAAS statistics:*

** __Incoming requests__ - Count of HTTP requests inspected by WAAS since the start of aggregation.

** __Forwarded requests__ - Count of HTTP requests forwarded by WAAS to the protected application.

** __Interstitial pages served__ - Count of interstitial pages served by WAAS (interstitial pages are served once xref:../waas_advanced_settings.adoc#prisma_session[Prisma Sessions Cookies] are enabled).

** __reCAPTCHAs served__ - Count of reCAPTCHA challenges served by WAAS (when enabled as part of xref:../waas_bot_protection.adoc[bot protection]).

* *Application statistics* 

** Count of server responses returned from the protected application to WAAS grouped by HTTP response code prefix 

** Count of timeouts (a timeout is counted when a request is forwarded by WAAS to the protected application with no response received within the set timeout period).


NOTE: Existing WAAS and application statistics counts will be lost once users reset the aggregation start time. *`Reset`* will *not* affect WAAS errors and will not cause recent errors to be lost.

NOTE: For further details on WAAS deployment, monitoring and troubleshooting please refer to the xref:../deploy_waas.adoc[WAAS deployment page]
