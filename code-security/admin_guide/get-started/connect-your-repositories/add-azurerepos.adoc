:topic_type: task

[.task]

== Add Azure Repos to Prisma Cloud Code Security

Integrating Prisma Cloud with Azure Repos makes it possible for Cloud Code Security to scan your Infrastructure-as-code files (Terraform and CloudFormation) and monitor configuration issues in development.
As a prerequisite you are required to add the Prisma Cloud IP addresses and hostname for Code Security to an allow list, to https://docs.paloaltonetworks.com/prisma/prisma-cloud/prisma-cloud-admin/get-started-with-prisma-cloud/enable-access-prisma-cloud-console.html#id7cb1c15c-a2fa-4072-%20b074-063158eeec08[enable access to the Prisma Cloud Console].
The integration uses an Azure DevOps user token for configuration. Prisma Cloud for Azure Repos supports multiple user tokens where you can add one or more Azure Repos to a new or existing integration. You can configure the integration two ways:

* Using Single Organization configuration.
+
A single organization configuration enables you to add multiple organizations using different user tokens. Prisma Cloud also supports adding new organizations to an existing integration. You add a new organization to an existing integration either by using a new user token or by adding the organization to the existing user token on Azure DevOps console. The number of new integrations will not impact any preferences you may have already configured on the Prima Cloud console.


* Using Multiple Organization configuration.
+
A multiple organization configuration enables you to integrate a single user token that supports multiple organizations on the Azure DevOps console. A single integration here gives Prisma Cloud access to all organizations and the repositories associated with the user token for security scans.
You can add one or more user tokens that support multiple organizations on Azure DevOps. However, if two user tokens have a shared repository, any change made to the repository on the Prisma Cloud console will impact both user tokens. For example, if there are two user tokens, `azuredevops@paloaltonetworks.com` and a`zureproject@paloaltonetworks.com`, that share a common repository `azuredevops/dev/production5`. Using `azuredevops@paloaltonetworks.com`, you select `azuredevops/dev/production5` for a security scan on the Prisma Cloud console, this change then will also be visible on `azureproject@paloaltonetworks.com` user token integration.

Multiple user tokens are currently available only for repositories integrated on Azure Repos. Support for repositories integrated on GitLab or Bitbucket is not yet available.


=== Third-party OAuth on Azure DevOps console

For single and multiple organization configurations, you must enable Third-party application access via OAuth on the Azure DevOps console.
image::=[width=600]
The third-party OAuth gives Prisma Cloud access to all your organizations associated with your user token. 


Multiple user token is currently available only for repositories integrated on Azure Repos. Support for repositories integrated on GitLab or Bitbucket is not yet available.

[.procedure]

. Verify prerequisites.
+
For Azure Repos integration with Prisma Cloud Code Security, you need to verify access to the Azure DevOps console to help with authorization and third-party application access OAuth access.
+
* Authorization access.
+
Access to Azure DevOps console enables you to grant authorization access to Prisma Cloud during integration to access organizations and repositories associated with your user token.

* Third-party OAuth application access.
+
For single and multiple organization configurations, you need to enable Third-party application access via OAuth on the Azure DevOps console.
+
image::azure-third-party-oauth.png[width=800]
+
The https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/change-application-access-policies?view=azure-devops[third-party application access OAuth ]gives Prisma Cloud access to all your organizations associated with your user token.
+
For Single organization configuration, you need to enable third-party application access OAuth only when you add a new organization integration using the integrated user token on the Prisma Cloud console.

. Access Azure Repos on Prisma Cloud Code Security.

.. Select *Settings > Repositories > Add Repositories*.

.. Select *Azure Repos*.
+
image::azure-repos-select.png[width=800]

. Authorize and configure Azure Repos account with Prisma Cloud console.

.. Select *Authorize* to configure an Azure Repos account with Single Organization.
+
image::azure-repos-1.png[width=600]
+
If there is an existing Azure Repos integration, you can continue with the single organization configuration to integrate another Azure Repos account with Prisma Cloud.
+
image::azure-repos-2.png[width=600]
+
You can optionally select *Multiple Organization* and then *Authorize* to configure an Azure Repos account with <<using-multiple-organization-configuration, Multiple Organization>>.
+
image::azure-repos-3.png[width=600]
+
For existing Azure Repos integration on single and multiple organization, you can additionally choose to either *Reselect repositories* or *Revoke OAuth User Token*.
+
image::azure-repos-4.png[width=600]
+
NOTE: If only a single Azure Repos integration exists, then revoking the OAuth user token will delete the integration entirely.

.. Access the Azure DevOps console and then select *Accept* to authorize the Prisma Cloud console to access your organization account and repositories.

. Select repositories corresponding to a user token for security scans.

.. Select the user token to enable repositories for a security scan.
+
image::azure-repos-5.png[width=600]

.. To select repositories for scan, you can choose from the following options.
+
* *Permit all existing repositories*: This option gives Prisma Cloud access to scan all existing repositories that are part of the user token.
* *Permit all existing and future repositories*: This option gives Prisma Cloud access to scan all existing repositories and any new repositories that are part of the user token.
* *Choose from repository list*: This option helps you view the list of repositories that are a part of the user token, enabling you to select specific repositories for a scan.
+
NOTE: A single repository may be shared across one or more user tokens. In this case, any change made to a shared repository scan applies to all associated user tokens.
+
image::azure-repos-6.png[width=600]
+
You can also manage repository scans for other integrated user tokens by selecting the user token to make the changes.

.. Select *Next* to confirm the repository selection and save the changes.
+
image::azure-repos-7.png[width=600]

. Confirm the Azure Repos integration with Prisma Cloud.

.. A *New integration successfully configured* message appears after integration is successfully set up, and then select *Done*.
+
image::azure-repo-status.png[width=600]
+
The Azure Repos integration you added displays on *Settings > Repositories.*
+
On *Repositories* you can view the new integrated Azure Repos either from columns of *VCS User Token* or *Repository*.
+
image::azure-repos-9.png[width=800]
+
On Repositories, you can also manage the integration by reselection of repositories and deletion of the repository and the integration. However, you cannot delete the integration from *Repositories*for an account integration through multiple organization configuration.
+
* *Reselect repositories*: Enables you to access the list of repositories for a scan.
* *Delete repository*: Enables you to delete repositories for a scan from the account.
* *Manage VCS user tokens*: Enables you to integrate one or more Azure Repos account.
+
image::azure-repos-8.png[width=600]
+
After a code security scan, access *Code Security > Projects* to view the latest integrated Azure Repos repository to https://docs.paloaltonetworks.com/prisma/prisma-cloud/prisma-cloud-admin-code-security/scan-monitor/monitor-fix-issues-in-scan[Suppress] or https://docs.paloaltonetworks.com/prisma/prisma-cloud/prisma-cloud-admin-code-security/scan-monitor/monitor-fix-issues-in-scan[Fix] the policy misconfigurations.
