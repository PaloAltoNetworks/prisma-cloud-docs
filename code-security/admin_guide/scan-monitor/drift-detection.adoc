== Drift Detection

Prisma Cloud Code Security supports Drift Detection for your repositories.
Drifts are inconsistencies in configuration that occur when resources are modified locally or manually using the CLI or console, and these divergences from the code are not recorded or tracked. The inconsistencies in code configuration can either be an addition or deletion of  values from the template configuration in source code.
Code Security periodically scans your repositories to identify drifts that may occur between the build and deploy phase and enables you with corrective solutions to handle traceable configuration changes.

Drift detection is currently available only for resources that are deployed using Terraform and CloudFormation on AWS and Azure. Support for resources deployed on Google Cloud Platform (GCP) templates are not yet available.

After you take a corrective solution for the drift on the Prisma Cloud console, you can view the before and after configuration changes made to the code.

For each drift detection scan, you can view the following details for a resource block.

1. Resource Block and Resource Name
+
The drift detection scan identifies the resource block and name. The resource block is the grouping of configuration or settings associated with a given resource.
2. Before Drift
+
The original or unchanged configuration changes of the resource.
3. After Drift
+
The modified configuration changes you made either locally or manually to the resource block with the changes that include adding or deleting a value within code, appear on the console. The configuration changes include any modification of add or delete values within code.
4. Resource History
+
The audit trail of configuration changes made to a resource that helps you review the updates anytime. This includes configuration changes of adding or deleting a value, and xref:monitor-fix-issues-in-scan.adoc[fixing scan issues] within code.
+
image::drift.png[width=800]
+
Continue to <<setup-drift-detection>>

[#setup-drift-detection]
=== Set up Drift Detection

For a drift detection scan to run on your repository you need to connect your AWS and Azure cloud account and code repositories to Prisma Cloud.
After you connect the repository setup https://yor.io/[Yor] on your repository and xref:iac-tag-and-trace.adoc[enable tag and trace management].

* Onboard your AWS and Azure cloud account and code repositories to Prisma Cloud.
+
The AWS and Azure cloud account and code repositories must be connected to Prisma Cloud. For more details to onboard your cloud accounts see, https://docs.paloaltonetworks.com/prisma/prisma-cloud/prisma-cloud-admin/connect-your-cloud-platform-to-prisma-cloud/onboard-your-aws-account[AWS] and https://docs.paloaltonetworks.com/prisma/prisma-cloud/prisma-cloud-admin/connect-your-cloud-platform-to-prisma-cloud/onboard-your-azure-account[Azure] and then xref:../get-started/connect-your-repositories/connect-your-repositories.adoc[Connect Your Repositories to Code Security] that hosts the Terraform and CloudFormation templates used to deploy resources on the AWS and Azure cloud account.
+
If you have previously onboarded your AWS cloud account on Prisma Cloud, you must enable the additional permissions required for a drift detection scan. See https://docs.paloaltonetworks.com/prisma/prisma-cloud/prisma-cloud-admin/connect-your-cloud-platform-to-prisma-cloud/onboard-your-aws-account/update-an-onboarded-aws-account[update an onboarded AWS account] for redeploying the stack with the required permissions that are included in the `AWSCloudFormationReadOnlyAccess` policy.
+
```
lambda:GetLayerVersion
lambda:GetEventSourceMapping
lambda:GetFunction
s3:ListBucket
sns:GetSubscriptionAttributes
```
+
Add the Prisma Cloud IP addresses and hostname for Code Security to an allow list, to https://docs.paloaltonetworks.com/prisma/prisma-cloud/prisma-cloud-admin/get-started-with-prisma-cloud/enable-access-prisma-cloud-console.html#id7cb1c15c-a2fa-4072-%20b074-063158eeec08[enable access to the Prisma Cloud Console].

* Set up Yor
+
Yor is an open-source tool that helps you manage tags consistently across infrastructure as code frameworks on your CI/CD. To set up Yor for your repository you need to install and run Yor and then enable Yor to scan your repository for a drift detection scan.
+
* Install and Run Yor.
+
You can choose to install Yor either through a https://yor.io/2.Using%20Yor/installation.html[GitHub Actions or GitLab CI].
+
* Enable Yor on the Prisma Cloud console.
+
Enable automated resource trace tags to a new or modified IaC resource blocks using *Code Security > Projects > Manage tags* to enable the `yor_trace` tag. For further details on how to manage tags see xref:iac-tag-and-trace.adoc[IaC Tag and Trace].

[.task]
=== Manage Drift

You can manage drift detection scan results for your repository either through Suppress or Fix Drift.

[.procedure]

. Review  drift detection scan results for your repository.

.. Select *Code Security > Projects*.
+
image::drift-1.png[width=600]

.. Select a repository.
+
image::drift-2.png[width=600]

.. Select *Category > Drift* to view the drift detection scan results within your repository.

. Take action to manage drift detection scan results.
+
You can either Suppress or Fix Drift.

* *Suppress*
+
Enables you to revert a resource block to its previous configuration change before any local or manual modifications. With suppression, you can enforce the configuration as defined in the IaC template and revert any changes to the running resource.
+
image::drift-3.png[width=600]
+
Suppressing a drift will continue to display the drift detection result until the next scan where the running resource is compliant and the drift is fixed.
* *Fix Drift*
+
Enables you to apply the configuration change that includes the manual changes made to the resource block, within  the template. Fix Drift creates a PR (Pull Request) directly from your code to implement configuration changes on the template. When you fix drift, you correct the template configuration to match the running configuration of the resource.
+
image::drift-4.png[width=600]

[.task]

=== Create Alert Rules for Drift Detection

Create alert rules for Drift Detection to help you in notifying when a drift occurs for AWS (Amazon Web Services) and Azure resources.
When creating a Drift Alert rule, you must specify the account groups to which you would like to  receive alerts and add policies to the account groups. You can create a single alert rule that includes all account groups and policies. You can also customize alert rules to include details like Policy Severity, Policy Compliance or Policy Label with regions, and even resource tags.
Drift Alerts currently only support resources deployed on Amazon Web Services (AWS) and Azure cloud accounts. Support for resources deployed on Google Cloud Platform (GCP) cloud accounts is not yet available.
You can create a single rule alert for all account groups or choose to customize an alert rule for a specific requirement.

[.procedure]

. Verify that the policies for AWS and Azure are enabled.

.. Select *Policies* and verify if the specific policies are enabled for AWS and Azure cloud accounts.
In this example, the policy `AWS traced resources are manually modified` is enabled.
+
image::[width=800]

. Access alert rules.

.. Select *Alerts > Alert Rules* and then select *Add Alert Rules*.
+
image::[width=600]

. Add details to create an alert rule for the configuration build policy.

.. Add a name for the drift alert rule.
+
image::[width=600]

.. Add a description for the drift alert rule.
+
image::[width=600]
+
NOTE: Drift Alerts currently support only Alert notifications. Support for Auto- Remediation is currently not available.

.. Select *Next*.

. Add granularity to the rule by assigning targets.

.. Select *Account Groups* to apply the alert rule.
+
You can select all groups or choose groups to create a customized alert rule.
+
image::[width=600]
+
You can optionally add additional criteria to the alert rule:
+
* *Exclude Cloud Accounts*: You can select cloud accounts to be excluded from the alert rule. You will not receive an alert for the selected accounts.
+
* *Include Regions*: Select regions to include to receive alerts.
+
* *Include Resource Tags*: Add the Key and Value of the resource tag to receive alerts for the specific resources in the cloud accounts.

.. Select *Next*.

. Assign policies to the alert rule to receive policy violations.

.. Select specific policies to add to the rule to receive alerts.
+
In this example, policy `AWS traced resources are manually modified` is assigned to the alert rule.
+
image::[width=600]
+
You can optionally search for specific policies to enable drift alerts.
+
In this example, using the word ‘traced’ to search for policy `Traced Azure resources are manually modified`.
+
NOTE: It is recommended to apply the alert rules with granular selection to avoid many alerts if the rule is applied for all policies.

.. Select *Next*.

. Verify the alert rule with a summary.

.. View the detailed summary of the alert rule to verify the granular details before saving.
+
image::[width=600]
+
You can optionally select *Edit*, if you want to modify the existing granularity of the alert rule for *Added Details*, *Assigned Targets* and *Assigned Policies*.
+
image::[width=600]

.. Select *Save* to publish the alert rule on the Prisma Cloud console.
+
image::[width=600]
+
You can view the alert counts for the new drift detection on *Alerts > Overview.*

[.task]
=== View Drift Alerts on Prisma Cloud

After creating an alert rule, Prisma Cloud generates alerts on drifts detected for policies included in the alert rule monitoring AWS and Azure cloud resources for direct changes without code updates.

[.procedure]

. Access the policy violation alerts.

.. Select *Alerts > Alerts Overview*.

.. Search or filter the policy in the list.
+
In this example, using the word ‘traced’ to search for `AWS traced resources are manually modified.`
+
image::[width=600]

.. Select *Alert Count* to view the alerts with granular information.
+
In this example, for the `AWS traced resources are manually modified` policy, there are 15 alert counts. Accessing each alert gives you granular information for each drift alert with IaC Resource Details.
+
image::[width=600]

.. Select *Resource Name* to view information on drifts identified in a specific resource.

.. Select *Alert ID* to view the traceability of drifts within the resource.

See [Monitor Drift Detection Alerts] on Prisma Cloud to learn more about managing and monitoring alerts.
















